# AIアプリケーション インフラ設計書

## 1. 概要

### 1.1 目的

本設計書は、AIアプリケーションにおけるインフラ構成、Kubernetes環境、データ処理パイプライン、CI/CDパイプラインの設計方針を定義します。

### 1.2 システム概要

データを収集・分析し、AI技術を活用したプラットフォームです。

### 1.3 技術スタック

- **クラウドプラットフォーム**: AWS
- **コンテナオーケストレーション**: Kubernetes (EKS)
- **IaC**: Terraform / AWS CloudFormation
- **CI/CD**: GitHub Actions
- **データ処理**: データ処理パイプライン（Apache Airflow / AWS Step Functions / Kubeflow Pipelines 想定）
- **データベース**: SQL/NoSQL（Databricks使用可能性あり）
- **プロジェクト管理**: JIRA
- **コミュニケーション**: Slack

## 2. アーキテクチャ設計

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────┐
│                    GitHub Repository                     │
│  ┌─────────────────────────────────────────────────┐   │
│  │         GitHub Actions (CI/CD)                  │   │
│  └─────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│                      AWS EKS                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  Application │  │   AI Model   │  │    Data      │ │
│  │    Pods      │  │    Pods      │  │  Processing  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │         Data Pipeline Orchestrator              │   │
│  └─────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        ▼              ▼              ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│  RDS/    │  │  DynamoDB│  │ Databricks│
│ Aurora   │  │  /S3     │  │  (Optional)│
└──────────┘  └──────────┘  └──────────┘
```

### 2.2 ネットワーク設計

#### 2.2.1 VPC構成

- **VPC CIDR**: 10.0.0.0/16
- **Public Subnet**: 10.0.1.0/24, 10.0.2.0/24 (AZ別)
- **Private Subnet**: 10.0.10.0/24, 10.0.11.0/24 (AZ別)
- **Data Subnet**: 10.0.20.0/24, 10.0.21.0/24 (AZ別)

#### 2.2.2 セキュリティグループ設計

- **EKS Cluster SG**: クラスター間通信用
- **Application SG**: アプリケーションPod用
- **Data Pipeline SG**: データ処理パイプライン用
- **Database SG**: RDS/Aurora用（プライベートサブネットからのみアクセス可能）

### 2.3 Kubernetes構成

#### 2.3.1 EKSクラスター構成

- **Kubernetes Version**: 1.28+
- **Node Group**: 
  - **Managed Node Group**: 汎用的なアプリケーション用
  - **Fargate Profile**: サーバーレスコンテナ実行用（オプション）

#### 2.3.2 Namespace設計

- **production**: 本番環境
- **staging**: ステージング環境
- **development**: 開発環境
- **data-pipeline**: データ処理パイプライン専用

#### 2.3.3 リソース設計

- **Deployment**: アプリケーション、AIモデルサービング用
- **StatefulSet**: ステートフルなデータ処理ジョブ用
- **CronJob**: 定期実行するデータ処理ジョブ用
- **DaemonSet**: ログ収集、監視エージェント用

#### 2.3.4 ストレージ設計

- **EBS CSI Driver**: 永続ボリューム用
- **EFS CSI Driver**: 共有ストレージ用（複数Pod間でのデータ共有）

#### 2.3.5 Ingress設計

- **AWS Load Balancer Controller**: Application Load Balancer (ALB) を使用
- **Ingress Class**: alb
- **SSL/TLS**: AWS Certificate Manager (ACM) を使用したHTTPS終端

## 3. データ処理パイプライン設計

### 3.1 パイプライン構成

#### 3.1.1 データフロー

```
データソース → データ取得 → データ変換 → データ検証 → データ保存 → AIモデル学習/推論
    ↓            ↓            ↓            ↓            ↓              ↓
  S3/Kafka    ETL Job     Data Quality   Validation  Data Lake    Model Training
```

#### 3.1.2 パイプラインオーケストレーション

- **候補技術**:
  - Apache Airflow (Kubernetes上で実行)
  - AWS Step Functions
  - Kubeflow Pipelines
  - Argo Workflows

#### 3.1.3 データストレージ

- **データレイク**: Amazon S3
- **データウェアハウス**: Amazon Redshift / Databricks（オプション）
- **NoSQL**: Amazon DynamoDB（リアルタイムデータ用）
- **RDBMS**: Amazon RDS / Aurora（トランザクションデータ用）

### 3.2 スケーリング戦略

- **Horizontal Pod Autoscaler (HPA)**: CPU/メモリベースの自動スケーリング
- **Vertical Pod Autoscaler (VPA)**: リソース要求の最適化
- **Cluster Autoscaler**: Nodeレベルの自動スケーリング

## 4. CI/CDパイプライン設計

### 4.1 GitHub Actions ワークフロー

#### 4.1.1 開発フロー

```
┌─────────────┐
│ Push to PR  │
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│ Lint & Test     │
│ (Code Quality)  │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ Build Container │
│ (Docker Image)  │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ Deploy to Dev   │
│ (EKS Dev)       │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ Integration Test│
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ Deploy to Stg   │
│ (EKS Staging)   │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ Manual Approval │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ Deploy to Prod  │
│ (EKS Production)│
└─────────────────┘
```

#### 4.1.2 ワークフロー定義

**主要ステップ**:

1. **コード品質チェック**
   - Linter実行
   - 静的解析（SonarQube等）
   - セキュリティスキャン（Trivy等）

2. **テスト実行**
   - 単体テスト
   - 統合テスト
   - E2Eテスト（必要に応じて）

3. **コンテナイメージビルド**
   - Dockerイメージビルド
   - Amazon ECRへのプッシュ
   - イメージタグ付け（Git SHA、ブランチ名等）

4. **IaC適用**
   - Terraform Plan実行
   - Terraform Apply（承認後）
   - インフラ変更の検証

5. **Kubernetesデプロイ**
   - kubectl / Helmを使用したデプロイ
   - ロールアウト検証
   - ヘルスチェック

#### 4.1.3 環境別デプロイ戦略

- **Development**: 自動デプロイ（mainブランチへのマージ時）
- **Staging**: 自動デプロイ（リリースブランチへのマージ時）
- **Production**: 手動承認後にデプロイ

### 4.2 コンテナイメージ管理

- **レジストリ**: Amazon ECR
- **イメージタグ**: Git SHA、Semantic Versioning
- **イメージスキャン**: 脆弱性スキャンの自動実行
- **ライフサイクルポリシー**: 古いイメージの自動削除

### 4.3 GitOps（オプション）

- **ArgoCD / Flux**: Kubernetesマニフェストの自動同期
- **Helm Charts**: アプリケーションのパッケージ管理

## 5. セキュリティ設計

### 5.1 認証・認可

- **EKS認証**: IAM Role for Service Account (IRSA)
- **コンテナレジストリ認証**: ECRへのアクセスはIAMポリシーで制御
- **Secrets管理**: AWS Secrets Manager / Kubernetes Secrets

### 5.2 ネットワークセキュリティ

- **Network Policy**: Pod間の通信制御
- **WAF**: Application Load Balancer前段での保護
- **VPC Flow Logs**: ネットワークトラフィックの監視

### 5.3 コンテナセキュリティ

- **イメージスキャン**: 脆弱性の早期検出
- **Pod Security Standards**: Kubernetes Podセキュリティ基準の適用
- **最小権限の原則**: 必要最小限の権限のみ付与

### 5.4 データセキュリティ

- **暗号化**: 
  - 転送時: TLS 1.3
  - 保存時: S3 SSE、RDS暗号化、EBS暗号化
- **アクセス制御**: IAMポリシー、Kubernetes RBAC

## 6. 監視・ロギング設計

### 6.1 メトリクス監視

- **Prometheus**: メトリクス収集
- **Grafana**: 可視化
- **CloudWatch**: AWSリソースの監視
- **アラート**: PagerDuty / Slack連携

### 6.2 ログ管理

- **コンテナログ**: Fluent Bit → CloudWatch Logs / Elasticsearch
- **アプリケーションログ**: 構造化ログ（JSON形式）
- **ログ保持期間**: 30日（本番）、7日（開発/ステージング）

### 6.3 分散トレーシング

- **AWS X-Ray**: リクエストトレーシング
- **Jaeger**: オープンソーストレーシング（オプション）

## 7. バックアップ・ディザスタリカバリ

### 7.1 バックアップ戦略

- **RDS/Aurora**: 自動スナップショット（1日1回、7日間保持）
- **S3**: バージョニング、クロスリージョンレプリケーション
- **Kubernetesリソース**: etcdスナップショット

### 7.2 ディザスタリカバリ

- **マルチAZ構成**: 高可用性確保
- **DRサイト**: 別リージョンへの災害時復旧手順の文書化

## 8. コスト最適化

### 8.1 リソース最適化

- **Spot Instances**: 開発環境でのNode Groupに適用
- **Reserved Instances**: 本番環境での予約インスタンス検討
- **Right Sizing**: リソース使用率の監視と最適化

### 8.2 コスト監視

- **AWS Cost Explorer**: コスト分析
- **タグ戦略**: プロジェクト、環境、コストセンター別のタグ付け

## 9. 運用・保守

### 9.1 運用体制

- **On-call**: 24/7監視体制（必要に応じて）
- **インシデント管理**: JIRA連携
- **変更管理**: 変更承認プロセスの文書化

### 9.2 定期メンテナンス

- **Kubernetesアップグレード**: 四半期ごとの検討
- **セキュリティパッチ**: 月次での適用検討
- **依存関係の更新**: 週次での確認

## 10. 技術選定の考慮事項

### 10.1 採用技術の選択理由

- **EKS**: マネージドKubernetesサービスで運用負荷を軽減
- **GitHub Actions**: コードリポジトリと統合されたCI/CD
- **IaC**: Terraform/CloudFormationによるインフラのコード化

### 10.2 今後の拡張性

- **マルチクラウド対応**: 将来的なマルチクラウド展開への準備
- **エッジコンピューティング**: IoTデバイスとの連携拡張
- **AI/ML機能の強化**: MLOpsパイプラインの拡充

## 11. 参考文献・参考資料

- AWS Well-Architected Framework
- Kubernetes Best Practices
- CNCF Landscape
- Databricks Architecture Best Practices（Databricks使用の場合）
