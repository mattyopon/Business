# セキュリティ・ガバナンスドキュメント

## 1. 概要

### 1.1 目的
本ドキュメントは、医療データを扱うシステムのセキュリティ要件とガバナンス体制を定義する。

### 1.2 適用規制・ガイドライン

| 規制・ガイドライン | 内容 | 適用 |
|------------------|------|------|
| 個人情報保護法 | 個人情報の適切な取り扱い | 必須 |
| 医療情報ガイドライン | 厚労省「医療情報システムの安全管理に関するガイドライン」 | 必須 |
| 3省2ガイドライン | 医療情報の外部保存ガイドライン | 必須 |
| AWS Well-Architected | セキュリティピラー | 推奨 |
| HIPAA | 米国医療情報保護法（海外展開時） | 条件付き |

---

## 2. セキュリティアーキテクチャ

### 2.1 多層防御モデル

```
                    ┌─────────────────────────────────────┐
                    │         Edge Protection              │
                    │  (CloudFront + WAF + Shield)         │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │         Network Security             │
                    │  (VPC + Security Groups + NACL)      │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │         Application Security         │
                    │  (認証・認可・入力検証)              │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │         Data Security                │
                    │  (暗号化・アクセス制御・監査)        │
                    └─────────────────────────────────────┘
```

### 2.2 ゼロトラストアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    Zero Trust Architecture                       │
│                                                                   │
│  原則:                                                           │
│  1. すべてのアクセスを検証（場所に関係なく）                    │
│  2. 最小権限アクセス                                             │
│  3. 侵害を想定した設計                                           │
│                                                                   │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   Identity  │───>│   Device    │───>│   Access    │         │
│  │ Verification│    │ Validation  │    │  Decision   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│        │                   │                   │                 │
│        └───────────────────┴───────────────────┘                 │
│                            │                                      │
│                    ┌───────▼───────┐                             │
│                    │   Continuous  │                             │
│                    │   Monitoring  │                             │
│                    └───────────────┘                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. IAM設計

### 3.1 IAM設計原則

- **最小権限の原則**: 必要最小限の権限のみ付与
- **職責分離**: 開発者と運用者の権限分離
- **MFA必須**: すべてのIAMユーザーにMFA必須
- **一時的認証情報**: 長期認証情報より一時認証情報を優先

### 3.2 IAMロール設計

| ロール名 | 用途 | 信頼されたエンティティ |
|---------|------|----------------------|
| EKSClusterRole | EKSクラスター | eks.amazonaws.com |
| EKSFargateRole | Fargate Pod | eks-fargate-pods.amazonaws.com |
| LambdaExecutionRole | Lambda関数 | lambda.amazonaws.com |
| CICDDeployRole | CI/CDデプロイ | GitHub OIDC |
| DeveloperRole | 開発者アクセス | IAMユーザー（MFA必須） |
| AdminRole | 管理者アクセス | IAMユーザー（MFA必須） |

### 3.3 IAMポリシー例（最小権限）

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowECRPull",
      "Effect": "Allow",
      "Action": [
        "ecr:GetDownloadUrlForLayer",
        "ecr:BatchGetImage",
        "ecr:BatchCheckLayerAvailability"
      ],
      "Resource": "arn:aws:ecr:ap-northeast-1:123456789012:repository/medical-ai-*"
    },
    {
      "Sid": "AllowS3ModelAccess",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::medical-ai-prod-models",
        "arn:aws:s3:::medical-ai-prod-models/*"
      ]
    },
    {
      "Sid": "DenyUnencryptedS3",
      "Effect": "Deny",
      "Action": "s3:PutObject",
      "Resource": "*",
      "Condition": {
        "Null": {
          "s3:x-amz-server-side-encryption": "true"
        }
      }
    }
  ]
}
```

### 3.4 スイッチロール設定

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111111111111:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "Bool": {
          "aws:MultiFactorAuthPresent": "true"
        },
        "IpAddress": {
          "aws:SourceIp": ["203.0.113.0/24"]
        }
      }
    }
  ]
}
```

---

## 4. データ保護

### 4.1 暗号化方針

| データ状態 | 暗号化方式 | 鍵管理 |
|-----------|-----------|--------|
| 保存時（At Rest） | AES-256 | AWS KMS（CMK） |
| 転送時（In Transit） | TLS 1.2+ | ACM証明書 |
| アプリ内暗号化 | AES-256-GCM | Secrets Manager |

### 4.2 KMS設定

```hcl
# KMS CMK定義
resource "aws_kms_key" "medical_data" {
  description             = "CMK for medical data encryption"
  deletion_window_in_days = 30
  enable_key_rotation     = true

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid    = "Enable IAM policies"
        Effect = "Allow"
        Principal = {
          AWS = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
        }
        Action   = "kms:*"
        Resource = "*"
      },
      {
        Sid    = "Allow use of the key"
        Effect = "Allow"
        Principal = {
          AWS = [
            aws_iam_role.eks_fargate.arn,
            aws_iam_role.lambda.arn
          ]
        }
        Action = [
          "kms:Encrypt",
          "kms:Decrypt",
          "kms:ReEncrypt*",
          "kms:GenerateDataKey*",
          "kms:DescribeKey"
        ]
        Resource = "*"
      }
    ]
  })

  tags = {
    Name        = "medical-data-cmk"
    Environment = var.environment
    Compliance  = "medical-data"
  }
}

resource "aws_kms_alias" "medical_data" {
  name          = "alias/medical-data"
  target_key_id = aws_kms_key.medical_data.key_id
}
```

### 4.3 データ分類

| 分類 | 説明 | 例 | 取り扱い |
|------|------|-----|----------|
| 機密 | 患者個人を特定可能 | 氏名、生年月日、診療情報 | 暗号化必須、アクセスログ必須 |
| 内部 | 業務上の情報 | モデルパラメータ、設定 | 暗号化推奨 |
| 公開 | 公開可能な情報 | APIドキュメント | 制限なし |

### 4.4 データマスキング

```python
# データマスキング例
import hashlib

def mask_patient_id(patient_id: str, salt: str) -> str:
    """患者IDをハッシュ化してマスキング"""
    return hashlib.sha256(f"{salt}{patient_id}".encode()).hexdigest()[:16]

def mask_name(name: str) -> str:
    """氏名をマスキング（最初の1文字のみ表示）"""
    if len(name) <= 1:
        return "*"
    return name[0] + "*" * (len(name) - 1)

def mask_date(date_str: str) -> str:
    """生年月日をマスキング（年のみ表示）"""
    # YYYY-MM-DD -> YYYY-**-**
    return date_str[:4] + "-**-**"
```

---

## 5. ネットワークセキュリティ

### 5.1 WAF設定

```hcl
resource "aws_wafv2_web_acl" "main" {
  name        = "medical-ai-waf"
  description = "WAF for medical AI platform"
  scope       = "CLOUDFRONT"

  default_action {
    allow {}
  }

  # AWSマネージドルール - 共通攻撃対策
  rule {
    name     = "AWSManagedRulesCommonRuleSet"
    priority = 1

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        vendor_name = "AWS"
        name        = "AWSManagedRulesCommonRuleSet"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesCommonRuleSet"
      sampled_requests_enabled   = true
    }
  }

  # SQLインジェクション対策
  rule {
    name     = "AWSManagedRulesSQLiRuleSet"
    priority = 2

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        vendor_name = "AWS"
        name        = "AWSManagedRulesSQLiRuleSet"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedRulesSQLiRuleSet"
      sampled_requests_enabled   = true
    }
  }

  # レートベース制限
  rule {
    name     = "RateLimitRule"
    priority = 3

    action {
      block {}
    }

    statement {
      rate_based_statement {
        limit              = 2000
        aggregate_key_type = "IP"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "RateLimitRule"
      sampled_requests_enabled   = true
    }
  }

  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "medical-ai-waf"
    sampled_requests_enabled   = true
  }
}
```

### 5.2 VPCエンドポイント

```hcl
# S3 Gateway Endpoint
resource "aws_vpc_endpoint" "s3" {
  vpc_id       = aws_vpc.main.id
  service_name = "com.amazonaws.ap-northeast-1.s3"

  route_table_ids = [
    aws_route_table.private.id
  ]

  tags = {
    Name = "${var.name_prefix}-s3-endpoint"
  }
}

# ECR API Interface Endpoint
resource "aws_vpc_endpoint" "ecr_api" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.ap-northeast-1.ecr.api"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints.id]
  private_dns_enabled = true

  tags = {
    Name = "${var.name_prefix}-ecr-api-endpoint"
  }
}

# Secrets Manager Interface Endpoint
resource "aws_vpc_endpoint" "secrets_manager" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.ap-northeast-1.secretsmanager"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints.id]
  private_dns_enabled = true

  tags = {
    Name = "${var.name_prefix}-secrets-manager-endpoint"
  }
}
```

---

## 6. 監査ログ

### 6.1 ログ収集対象

| ログ種別 | ソース | 保存先 | 保持期間 |
|---------|--------|--------|----------|
| APIアクセスログ | CloudFront | S3 + CloudWatch Logs | 1年 |
| 認証ログ | Cognito | CloudWatch Logs | 1年 |
| 管理操作ログ | CloudTrail | S3 | 7年 |
| データアクセスログ | Aurora監査ログ | CloudWatch Logs | 1年 |
| VPCフローログ | VPC | CloudWatch Logs | 90日 |

### 6.2 CloudTrail設定

```hcl
resource "aws_cloudtrail" "main" {
  name                          = "medical-ai-trail"
  s3_bucket_name                = aws_s3_bucket.cloudtrail.id
  include_global_service_events = true
  is_multi_region_trail         = true
  enable_log_file_validation    = true
  kms_key_id                    = aws_kms_key.cloudtrail.arn

  # データイベント（S3、Lambda）
  event_selector {
    read_write_type           = "All"
    include_management_events = true

    data_resource {
      type   = "AWS::S3::Object"
      values = ["arn:aws:s3:::medical-ai-prod-data/"]
    }
  }

  # CloudWatch Logs統合
  cloud_watch_logs_group_arn = "${aws_cloudwatch_log_group.cloudtrail.arn}:*"
  cloud_watch_logs_role_arn  = aws_iam_role.cloudtrail_cloudwatch.arn

  tags = {
    Name        = "medical-ai-trail"
    Compliance  = "audit"
  }
}
```

### 6.3 監査ログアラート

```yaml
# 不正アクセス検知
- alert: UnauthorizedAPICall
  expr: |
    sum(rate(cloudtrail_unauthorized_api_calls[5m])) > 0
  for: 1m
  labels:
    severity: critical
    compliance: security
  annotations:
    summary: "Unauthorized API call detected"

# ルートアカウント使用検知
- alert: RootAccountUsage
  expr: |
    sum(rate(cloudtrail_root_account_usage[5m])) > 0
  for: 1m
  labels:
    severity: critical
    compliance: security
  annotations:
    summary: "Root account usage detected"
```

---

## 7. インシデント対応

### 7.1 セキュリティインシデント分類

| レベル | 説明 | 例 | 対応時間 |
|--------|------|-----|----------|
| P1 | データ漏洩の可能性 | 不正アクセス成功 | 即時 |
| P2 | 攻撃の兆候 | 大量の不正アクセス試行 | 30分以内 |
| P3 | 軽微なセキュリティイベント | 設定ミス検出 | 24時間以内 |

### 7.2 インシデント対応フロー

```
1. 検知・報告
   - 自動検知（GuardDuty、WAF）
   - 手動報告（ユーザー、従業員）
   ↓
2. トリアージ（15分以内）
   - 影響範囲の特定
   - インシデントレベル判定
   ↓
3. 封じ込め（P1: 即時、P2: 1時間以内）
   - アクセス遮断
   - 該当システムの隔離
   ↓
4. 根絶
   - マルウェア除去
   - 脆弱性修正
   ↓
5. 復旧
   - システム復旧
   - 監視強化
   ↓
6. 事後対応
   - インシデントレポート作成
   - 再発防止策の実施
   - 関係機関への報告（必要に応じて）
```

### 7.3 連絡体制

| 役割 | 担当 | 連絡先 |
|------|------|--------|
| インシデントマネージャー | [担当者名] | [連絡先] |
| セキュリティチームリード | [担当者名] | [連絡先] |
| 法務担当 | [担当者名] | [連絡先] |
| 広報担当 | [担当者名] | [連絡先] |

---

## 8. コンプライアンスチェックリスト

### 8.1 定期チェック項目

| チェック項目 | 頻度 | 担当 |
|-------------|------|------|
| IAMユーザー棚卸し | 四半期 | セキュリティチーム |
| アクセスキーローテーション | 90日 | 自動 |
| セキュリティグループ監査 | 月次 | インフラチーム |
| 暗号化状態確認 | 月次 | インフラチーム |
| 脆弱性スキャン | 週次 | 自動 |
| ペネトレーションテスト | 年次 | 外部ベンダー |

### 8.2 AWS Config ルール

```hcl
# 暗号化チェック
resource "aws_config_config_rule" "s3_encryption" {
  name = "s3-bucket-server-side-encryption-enabled"

  source {
    owner             = "AWS"
    source_identifier = "S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED"
  }
}

# パブリックアクセスチェック
resource "aws_config_config_rule" "s3_public_access" {
  name = "s3-bucket-public-read-prohibited"

  source {
    owner             = "AWS"
    source_identifier = "S3_BUCKET_PUBLIC_READ_PROHIBITED"
  }
}

# RDS暗号化チェック
resource "aws_config_config_rule" "rds_encryption" {
  name = "rds-storage-encrypted"

  source {
    owner             = "AWS"
    source_identifier = "RDS_STORAGE_ENCRYPTED"
  }
}
```

---

## 9. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2026-01-XX | 1.0 | 初版作成 | - |
