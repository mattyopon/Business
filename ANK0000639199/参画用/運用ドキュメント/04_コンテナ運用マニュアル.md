# コンテナ運用マニュアル

## 1. 概要

### 1.1 目的
本ドキュメントは、Docker/ECS/EKSを使用したコンテナ環境の運用手順を定義する。

### 1.2 対象環境

| 環境 | オーケストレーション | 用途 |
|------|---------------------|------|
| Production | EKS (Fargate) | 本番ワークロード |
| Staging | EKS (Fargate) | 検証環境 |
| Development | ECS (Fargate) | 開発環境 |

---

## 2. Docker イメージ管理

### 2.1 Dockerfile ベストプラクティス

```dockerfile
# ベースイメージは公式イメージを使用
FROM python:3.11-slim AS builder

# マルチステージビルドで軽量化
WORKDIR /app

# 依存関係を先にコピー（キャッシュ効率化）
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# アプリケーションコード
COPY . .

# 本番用ステージ
FROM python:3.11-slim AS production

# 非rootユーザーで実行
RUN useradd -m -s /bin/bash appuser
USER appuser

WORKDIR /app

# 必要なファイルのみコピー
COPY --from=builder /app /app
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

EXPOSE 8000

CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 2.2 イメージタグ戦略

| タグ | 用途 | 例 |
|-----|------|-----|
| latest | 開発用（本番では使用禁止） | app:latest |
| セマンティックバージョン | リリース版 | app:1.2.3 |
| Git SHA | CI/CD用 | app:abc1234 |
| 環境名 | 環境固定 | app:production |

```bash
# イメージビルド例
docker build -t medical-ai-api:1.2.3 -t medical-ai-api:abc1234 .

# ECRへプッシュ
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com

docker tag medical-ai-api:1.2.3 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/medical-ai-api:1.2.3
docker push 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/medical-ai-api:1.2.3
```

### 2.3 脆弱性スキャン

```yaml
# GitHub Actions での脆弱性スキャン
- name: Run Trivy vulnerability scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'medical-ai-api:${{ github.sha }}'
    format: 'table'
    exit-code: '1'
    severity: 'CRITICAL,HIGH'
```

---

## 3. EKS運用

### 3.1 クラスター情報

| 項目 | Production | Staging |
|------|------------|---------|
| クラスター名 | medical-ai-prod-eks | medical-ai-stg-eks |
| Kubernetes Version | 1.28 | 1.28 |
| ノードタイプ | Fargate | Fargate |

### 3.2 kubectl設定

```bash
# kubeconfig更新
aws eks update-kubeconfig --name medical-ai-prod-eks --region ap-northeast-1

# コンテキスト確認
kubectl config get-contexts

# コンテキスト切り替え
kubectl config use-context arn:aws:eks:ap-northeast-1:123456789012:cluster/medical-ai-prod-eks

# クラスター情報確認
kubectl cluster-info
```

### 3.3 Namespace設計

| Namespace | 用途 | リソース制限 |
|-----------|------|-------------|
| default | デフォルト（使用禁止） | - |
| app | アプリケーション | CPU: 10, Mem: 20Gi |
| mlops | ML推論サービス | CPU: 20, Mem: 40Gi |
| monitoring | 監視ツール | CPU: 5, Mem: 10Gi |
| kube-system | システムコンポーネント | - |

```yaml
# ResourceQuota定義
apiVersion: v1
kind: ResourceQuota
metadata:
  name: app-quota
  namespace: app
spec:
  hard:
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    pods: "50"
```

### 3.4 デプロイメント管理

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server
  namespace: app
  labels:
    app: api-server
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-server
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: api-server
    spec:
      containers:
      - name: api
        image: 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/medical-ai-api:1.2.3
        ports:
        - containerPort: 8000
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "1000m"
            memory: "2Gi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: url
```

---

## 4. 日常運用タスク

### 4.1 Pod状態確認

```bash
# Pod一覧
kubectl get pods -n app

# Pod詳細
kubectl describe pod <pod-name> -n app

# Podログ
kubectl logs <pod-name> -n app -f

# 複数コンテナの場合
kubectl logs <pod-name> -c <container-name> -n app

# 過去のログ（前回クラッシュ分）
kubectl logs <pod-name> -n app --previous
```

### 4.2 リソース確認

```bash
# リソース使用状況
kubectl top pods -n app
kubectl top nodes

# HPA状態
kubectl get hpa -n app

# PDB状態
kubectl get pdb -n app
```

### 4.3 スケーリング

```bash
# 手動スケール
kubectl scale deployment api-server --replicas=5 -n app

# HPA設定確認
kubectl get hpa api-server -n app -o yaml

# HPAによる自動スケール設定
kubectl autoscale deployment api-server \
  --min=3 --max=10 --cpu-percent=70 -n app
```

---

## 5. デプロイメント手順

### 5.1 通常デプロイ

```bash
# 1. イメージ更新
kubectl set image deployment/api-server \
  api=123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/medical-ai-api:1.2.4 \
  -n app

# 2. ロールアウト状態確認
kubectl rollout status deployment/api-server -n app

# 3. 履歴確認
kubectl rollout history deployment/api-server -n app
```

### 5.2 Canaryデプロイ

```yaml
# canary-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server-canary
  namespace: app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-server
      version: canary
  template:
    metadata:
      labels:
        app: api-server
        version: canary
    spec:
      containers:
      - name: api
        image: 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/medical-ai-api:1.2.4
```

```bash
# Canaryデプロイ実行
kubectl apply -f canary-deployment.yaml

# トラフィック分散確認
kubectl get pods -n app -l app=api-server

# 問題なければCanaryを昇格
kubectl set image deployment/api-server \
  api=123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/medical-ai-api:1.2.4 \
  -n app

# Canary削除
kubectl delete deployment api-server-canary -n app
```

### 5.3 ロールバック

```bash
# 直前のバージョンにロールバック
kubectl rollout undo deployment/api-server -n app

# 特定バージョンにロールバック
kubectl rollout undo deployment/api-server --to-revision=2 -n app

# ロールバック確認
kubectl rollout status deployment/api-server -n app
```

---

## 6. トラブルシューティング

### 6.1 よくある問題と対処

| 症状 | 原因 | 対処 |
|------|------|------|
| ImagePullBackOff | イメージ取得失敗 | ECR認証、イメージタグ確認 |
| CrashLoopBackOff | アプリ起動失敗 | ログ確認、設定確認 |
| Pending | リソース不足 | ノード追加、リソース調整 |
| OOMKilled | メモリ不足 | limits.memory増加 |

### 6.2 デバッグ手順

```bash
# 1. Pod状態確認
kubectl get pods -n app
kubectl describe pod <pod-name> -n app

# 2. イベント確認
kubectl get events -n app --sort-by='.lastTimestamp'

# 3. ログ確認
kubectl logs <pod-name> -n app

# 4. コンテナ内に入る
kubectl exec -it <pod-name> -n app -- /bin/sh

# 5. ネットワーク確認
kubectl run debug --image=busybox -it --rm -- sh
wget -qO- http://api-server.app.svc.cluster.local:8000/health
```

### 6.3 Fargateノード確認

```bash
# Fargateノード一覧
kubectl get nodes -l eks.amazonaws.com/compute-type=fargate

# ノード詳細
kubectl describe node <node-name>
```

---

## 7. 監視・アラート

### 7.1 メトリクス収集（Prometheus）

```yaml
# ServiceMonitor定義
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: api-server
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: api-server
  endpoints:
  - port: metrics
    interval: 15s
  namespaceSelector:
    matchNames:
    - app
```

### 7.2 アラートルール

```yaml
# PrometheusRule定義
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: api-server-alerts
  namespace: monitoring
spec:
  groups:
  - name: api-server
    rules:
    - alert: HighErrorRate
      expr: |
        sum(rate(http_requests_total{status=~"5.."}[5m])) /
        sum(rate(http_requests_total[5m])) > 0.01
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "High error rate detected"

    - alert: PodNotReady
      expr: kube_pod_status_ready{condition="false",namespace="app"} == 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Pod not ready"
```

---

## 8. セキュリティ

### 8.1 Pod Security Standards

```yaml
# namespace-security.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: app
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/warn: restricted
    pod-security.kubernetes.io/audit: restricted
```

### 8.2 NetworkPolicy

```yaml
# network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-server-policy
  namespace: app
spec:
  podSelector:
    matchLabels:
      app: api-server
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8000
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: app
    ports:
    - protocol: TCP
      port: 3306  # Aurora
```

---

## 9. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2026-01-XX | 1.0 | 初版作成 | - |
