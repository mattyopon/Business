# 設計判断記録 (ADR) - 医療系スタートアップ案件

## 概要

本資料は、医療業界向けクラウドインフラ構築における重要な設計判断（Architecture Decision Records）を記録します。各判断の背景、検討した代替案、選定理由、トレードオフを明確にしています。医療業界特有の要件（HIPAA、セキュリティ、ガバナンス等）も考慮しています。

## ADR-001: AWS HIPAA Eligible Servicesの採用

**ステータス**: 承認  
**日付**: 2026-01-XX  
**決定者**: インフラアーキテクト、セキュリティエンジニア、コンプライアンス担当者

### コンテキスト

医療業界向けクラウドインフラにおいて、HIPAA（Health Insurance Portability and Accountability Act）コンプライアンス要件を満たす必要がある。保護された医療情報（PHI: Protected Health Information）を扱うため、HIPAA Eligible Servicesを使用する必要がある。

### 検討した選択肢

1. **AWS HIPAA Eligible Services（選定）**
2. **セルフホスト型サービス（HIPAA要件を満たす構成）**
3. **他クラウドプロバイダー（Azure、GCP等）**

### 判断理由

**AWS HIPAA Eligible Servicesを選定した理由**:
- **コンプライアンス**: AWSがHIPAA Business Associate Agreement (BAA) を提供しており、HIPAAコンプライアンス要件を満たす
- **マネージドサービス**: セルフホスト型サービスと比較して、運用負荷を軽減
- **セキュリティ**: HIPAA Eligible Servicesは、HIPAA要件を満たすセキュリティ機能が標準で提供
- **監査**: HIPAA要件に基づく監査ログの記録が標準サポート
- **実績**: AWSは医療業界での実績が豊富

**セルフホスト型サービスを選択しなかった理由**:
- HIPAA要件を満たすためのセキュリティ機能の実装・維持に専門知識と時間が必要
- 運用負荷が高く、コストが高い
- 監査ログの記録・管理が複雑

**他クラウドプロバイダーを選択しなかった理由**:
- Azure、GCPもHIPAA対応だが、日本国内での医療業界の実績がAWSと比較して少ない
- チームのAWSスキルを活用できる

### トレードオフ

- **メリット**: コンプライアンス対応、運用負荷の軽減、セキュリティ機能、監査機能
- **デメリット**: HIPAA Eligible Servicesに限定されるため、一部のサービスが使用できない可能性

### 結果

AWS HIPAA Eligible Servicesを採用することで、HIPAAコンプライアンス要件を満たしながら、運用負荷を軽減できる。

---

## ADR-002: データ暗号化の必須化

**ステータス**: 承認  
**日付**: 2026-01-XX  
**決定者**: セキュリティエンジニア、インフラアーキテクト

### コンテキスト

医療データ（PHI）を扱うため、転送時・保存時の暗号化が必須である。HIPAA要件およびセキュリティベストプラクティスに基づき、すべてのデータを暗号化する必要がある。

### 検討した選択肢

1. **転送時・保存時の暗号化（選定）**
2. **保存時のみ暗号化**
3. **暗号化なし（推奨しない）**

### 判断理由

**転送時・保存時の暗号化を選定した理由**:
- **HIPAA要件**: HIPAAの技術的保護措置（Technical Safeguards）で、転送時・保存時の暗号化が推奨
- **セキュリティ**: データの機密性を確保し、不正アクセス時のリスクを低減
- **コンプライアンス**: 各種セキュリティ基準（ISO 27001、SOC 2等）で暗号化が要求
- **AWS標準**: S3、RDS、EBS等、AWSサービスで暗号化が標準サポート

**保存時のみ暗号化を選択しなかった理由**:
- 転送中のデータが暗号化されていない場合、ネットワーク盗聴のリスクがある
- HIPAA要件で転送時の暗号化も推奨されている

### 実装方針

1. **転送時暗号化**: TLS 1.3を使用したHTTPS通信、AWS PrivateLinkによるプライベート接続
2. **保存時暗号化**: 
   - S3: SSE-KMS（Server-Side Encryption with AWS KMS）
   - RDS/Aurora: 暗号化有効化（KMSキーを使用）
   - EBS: 暗号化有効化（KMSキーを使用）
3. **キー管理**: AWS KMSによる一元管理

### トレードオフ

- **メリット**: セキュリティの向上、コンプライアンス対応
- **デメリット**: 暗号化・復号化によるわずかなパフォーマンスオーバーヘッド、KMSのコスト

### 結果

転送時・保存時の暗号化を必須化することで、HIPAA要件を満たし、医療データの保護を強化できる。

---

## ADR-003: ネットワーク構成としてマルチAZ + プライベートサブネットを採用

**ステータス**: 承認  
**日付**: 2026-01-XX  
**決定者**: インフラアーキテクト、セキュリティエンジニア

### コンテキスト

医療データの保護と高可用性を確保するため、VPCネットワーク構成を設計する必要がある。以下の要件を満たす必要がある：
- 高可用性の確保（単一AZ障害時の可用性）
- セキュリティの強化（インターネットからの直接アクセス遮断）
- ネットワークセグメンテーション（データ層の分離）

### 検討した選択肢

1. **マルチAZ + プライベートサブネット（選定）**
2. **シングルAZ + プライベートサブネット**
3. **マルチAZ + パブリックサブネットのみ**

### 判断理由

**マルチAZ + プライベートサブネットを選定した理由**:
- **高可用性**: マルチAZ配置により、単一AZ障害時の可用性を確保（医療サービスの継続性が重要）
- **セキュリティ**: プライベートサブネットにアプリケーション層を配置し、インターネットからの直接アクセスを遮断
- **ネットワークセグメンテーション**: Application Layer、Data Layerを別サブネットに分離し、セキュリティ境界を明確化
- **ベストプラクティス**: AWS Well-Architected Frameworkの推奨構成
- **HIPAA要件**: アクセス制御（Access Control）の技術的保護措置に準拠

**シングルAZ + プライベートサブネットを選択しなかった理由**:
- 単一障害点が存在し、高可用性を確保できない（医療サービスの可用性要件に不適合）
- 単一AZ障害時にサービスが停止するリスク

**マルチAZ + パブリックサブネットのみを選択しなかった理由**:
- セキュリティリスクが高い（インターネットからの直接アクセス）
- HIPAA要件のアクセス制御に反する

### トレードオフ

- **メリット**: 高可用性、セキュリティ、ネットワークセグメンテーション
- **デメリット**: 初期構築コストがやや高い（NAT Gateway、マルチAZ構成等）

### 結果

マルチAZ + プライベートサブネット構成を採用することで、高可用性とセキュリティを確保し、HIPAA要件とAWS Well-Architected Frameworkの推奨構成に準拠できる。

---

## ADR-004: MLOpsパイプラインとしてSageMakerを採用

**ステータス**: 承認  
**日付**: 2026-01-XX  
**決定者**: MLエンジニア、インフラアーキテクト

### コンテキスト

AIモデルの運用（MLOps）パイプラインを構築する必要がある。以下の要件を満たす必要がある：
- HIPAA対応（医療データを扱うため）
- モデル開発からデプロイまでのライフサイクル管理
- モデルのガバナンスとバージョン管理
- モデルの継続的監視

### 検討した選択肢

1. **Amazon SageMaker（選定）**
2. **Kubeflow Pipelines**
3. **MLflow（セルフホスト型）**
4. **Databricks**

### 判断理由

**SageMakerを選定した理由**:
- **HIPAA対応**: SageMakerはHIPAA Eligible Serviceで、医療データの取り扱いに対応可能
- **マネージドサービス**: モデル開発からデプロイまで、MLライフサイクル全体をサポート
- **ガバナンス機能**: SageMaker Model Registry、Lineage等、モデル管理とガバナンス機能が充実
- **AWS統合**: S3、RDS、Lambda等、AWSサービスとの統合がシームレス
- **モデル監視**: SageMaker Model Monitorにより、モデルの継続的監視が可能
- **自動化**: SageMaker Pipelinesにより、MLワークフローの自動化が可能

**Kubeflow Pipelinesを選択しなかった理由**:
- セルフホスト型で運用負荷が高い
- HIPAA対応を自前で実装する必要がある

**MLflowを選択しなかった理由**:
- セルフホスト型で運用負荷が高い
- HIPAA対応を自前で実装する必要がある
- SageMakerと比較して、ガバナンス機能が限定的

**Databricksを選択しなかった理由**:
- AWS環境との統合がSageMakerほどシームレスではない
- 追加のコストが発生する

### トレードオフ

- **メリット**: HIPAA対応、マネージドサービス、ガバナンス機能、AWS統合
- **デメリット**: AWS専用で、ベンダーロックインのリスクがある

### 結果

SageMakerを採用することで、HIPAA対応を確保しながら、マネージドサービスで運用負荷を軽減し、ガバナンス機能を活用できる。

---

## ADR-005: HPC環境としてAWS ParallelClusterを採用（オプション）

**ステータス**: 条件付き承認（要件により）  
**日付**: 2026-01-XX  
**決定者**: データエンジニア、インフラアーキテクト

### コンテキスト

高負荷処理が必要なAI向けHPC（High Performance Computing）環境が必要な場合がある。大規模な科学計算、ゲノム解析、大規模ML訓練等のワークロードに対応する必要がある。

### 検討した選択肢

1. **AWS ParallelCluster（選定・要件により）**
2. **AWS Batch**
3. **セルフマネージドHPCクラスター**
4. **HPC環境なし（要件に応じて判断）**

### 判断理由

**ParallelClusterを選定した理由（HPC環境が必要な場合）**:
- **マネージドサービス**: HPCクラスターの構築・管理が容易
- **スケーラビリティ**: オンデマンドインスタンスとSpot Instancesの混在が可能
- **コスト最適化**: Spot Instancesの活用により、コストを大幅に削減可能（最大90%のコスト削減）
- **高性能ストレージ**: FSx for Lustre統合により、高スループット・低レイテンシのストレージを利用可能
- **ジョブスケジューラー**: Slurm、SGE、Torque等、多様なジョブスケジューラーに対応
- **自動スケーリング**: ジョブキューに基づく自動スケーリング

**AWS Batchを選択しなかった理由**:
- バッチジョブ向けだが、HPCクラスター管理機能がParallelClusterほど充実していない
- 複雑なワークロードにはParallelClusterの方が適している

**セルフマネージドHPCクラスターを選択しなかった理由**:
- 構築・運用負荷が高い
- スケーリングがParallelClusterほど柔軟ではない

**HPC環境なしを選択する場合**:
- ワークロードがHPC環境を必要としない場合（通常のML訓練、小規模データ処理等）
- コスト削減を優先する場合

### トレードオフ

- **メリット**: マネージドサービス、スケーラビリティ、コスト最適化、高性能ストレージ
- **デメリット**: HPC環境が必要ない場合は不要なコストが発生

### 結果

HPC環境が必要な場合は、AWS ParallelClusterを採用することで、運用負荷を軽減しながらコスト最適化が可能。ただし、要件に応じて必要性を判断する。

---

## ADR-006: Secrets管理としてAWS Secrets Managerを採用

**ステータス**: 承認  
**日付**: 2026-01-XX  
**決定者**: セキュリティエンジニア、インフラアーキテクト

### コンテキスト

医療データへのアクセス制御のため、Secrets管理が重要である。データベース認証情報、APIキー、暗号化キー等のSecretsを安全に管理する必要がある。

### 検討した選択肢

1. **AWS Secrets Manager（選定）**
2. **HashiCorp Vault**
3. **AWS Systems Manager Parameter Store**

### 判断理由

**Secrets Managerを選定した理由**:
- **自動ローテーション**: データベース認証情報等の自動ローテーション機能が標準サポート（セキュリティ強化）
- **AWS統合**: Lambda、RDS等との統合が容易
- **暗号化**: KMSによる暗号化が標準
- **監査**: CloudTrailによるアクセスログ（HIPAA要件の監査に対応）
- **HIPAA対応**: HIPAA Eligible Serviceで、医療データの取り扱いに対応可能

**Vaultを選択しなかった理由**:
- セルフホスト型で運用負荷が高い
- HIPAA対応を自前で実装する必要がある
- Secrets Managerで要件を満たせるため、追加の運用負荷を避ける

**Parameter Storeを選択しなかった理由**:
- 自動ローテーション機能がない（セキュリティリスク）
- Secrets Managerと比較して、ガバナンス機能が限定的

### トレードオフ

- **メリット**: 自動ローテーション、AWS統合、HIPAA対応、監査機能
- **デメリット**: Vaultと比較して、高度な機能が限定的

### 結果

Secrets Managerを採用することで、HIPAA対応を確保しながら、自動ローテーション機能を活用し、セキュリティを強化できる。

---

## ADR-007: 監視ツールとしてCloudWatch + Prometheus/Grafanaを併用

**ステータス**: 承認  
**日付**: 2026-01-XX  
**決定者**: SRE、インフラアーキテクト

### コンテキスト

医療サービスの可用性とセキュリティを確保するため、包括的な監視が必要である。AWSリソース、アプリケーション、Kubernetes環境を監視する必要がある。

### 検討した選択肢

1. **CloudWatch + Prometheus/Grafana（選定）**
2. **CloudWatchのみ**
3. **Prometheus/Grafanaのみ**
4. **Datadog、New Relic等のサードパーティツール**

### 判断理由

**CloudWatch + Prometheus/Grafanaを選定した理由**:
- **CloudWatch**: AWSリソース（RDS、S3、Lambda等）の監視に最適、HIPAA対応
- **Prometheus/Grafana**: Kubernetesメトリクスの監視に最適、柔軟なクエリと可視化
- **ハイブリッド構成**: 各ツールの強みを活かし、包括的な監視を実現
- **コスト効率**: CloudWatchはAWSリソース監視に標準で利用可能、Prometheus/Grafanaはオープンソースでコストがかからない

**CloudWatchのみを選択しなかった理由**:
- Kubernetesメトリクスの収集にPrometheusほど柔軟ではない
- カスタムメトリクスの収集がPrometheusほど容易ではない

**Prometheus/Grafanaのみを選択しなかった理由**:
- AWSリソースの監視にCloudWatchほど統合されていない
- HIPAA対応を自前で実装する必要がある

**サードパーティツールを選択しなかった理由**:
- 追加のコストが発生する
- オープンソースツールで要件を満たせるため

### トレードオフ

- **メリット**: 包括的な監視、コスト効率、HIPAA対応（CloudWatch）、柔軟性（Prometheus/Grafana）
- **デメリット**: 2つのツールを管理する必要がある（運用負荷がやや高い）

### 結果

CloudWatch + Prometheus/Grafanaのハイブリッド構成を採用することで、包括的な監視を実現し、HIPAA要件を満たしながらコスト効率を確保できる。

---

## ADR-008: コンテナ環境としてECS/EKSを要件に応じて選択

**ステータス**: 承認  
**日付**: 2026-01-XX  
**決定者**: インフラアーキテクト、アプリケーションエンジニア

### コンテキスト

コンテナ環境を選定する必要がある。要件の複雑さ、MLOps機能の必要性、チームのスキルレベル等を考慮して選択する必要がある。

### 検討した選択肢

1. **ECS（シンプルなワークロード）**
2. **EKS（複雑なワークロード、MLOps機能が必要な場合）**
3. **両方の併用（要件に応じて）**

### 判断理由

**ECSを選定する場合**:
- **シンプルさ**: Kubernetesと比較してシンプルで、学習コストが低い
- **AWS統合**: AWSサービスとの統合が非常に良好
- **運用負荷**: マネージドサービスで、運用負荷が低い
- **コスト**: EKSと比較してコストが低い
- **HIPAA対応**: ECSはHIPAA Eligible Service

**EKSを選定する場合**:
- **標準化**: KubernetesはCNCF標準で、ベンダーロックインを回避
- **エコシステム**: Helm、Istio、Prometheus等、豊富なKubernetesエコシステムを活用可能
- **MLOps統合**: Kubeflow Pipelines等、MLOpsツールとの統合が容易
- **スケーラビリティ**: HPA、Cluster Autoscaler等、柔軟なスケーリングが可能
- **HIPAA対応**: EKSはHIPAA Eligible Service

**選定基準**:
- 要件の複雑さ（シンプルなワークロードはECS、複雑なワークロードはEKS）
- MLOps機能の必要性（Kubeflow Pipelines等が必要な場合はEKS）
- チームのスキルレベル
- コスト制約

### トレードオフ

- **ECSのメリット**: シンプルさ、AWS統合、運用負荷、コスト
- **ECSのデメリット**: Kubernetesエコシステムが利用できない
- **EKSのメリット**: 標準化、エコシステム、MLOps統合、スケーラビリティ
- **EKSのデメリット**: 学習コストがやや高い、初期設定がやや複雑

### 結果

要件に応じてECS/EKSを選択することで、最適なコンテナ環境を構築できる。シンプルなワークロードはECS、複雑なワークロードやMLOps機能が必要な場合はEKSを採用する。

---

## 参考資料

- AWS Well-Architected Framework
- AWS HIPAA Eligible Services
- AWS Security Best Practices
- MLOps Best Practices
- HPC on AWS Best Practices
- Healthcare Information System Security Guidelines（日本の医療情報システム安全管理指針）
