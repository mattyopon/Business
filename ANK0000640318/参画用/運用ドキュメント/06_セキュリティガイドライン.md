# セキュリティガイドライン

## 1. 概要

### 1.1 目的
本ドキュメントは、金融決済プラットフォームのセキュリティ運用ガイドラインを定義する。

### 1.2 適用規格

| 規格 | 説明 | 適用範囲 |
|------|------|---------|
| PCI DSS v4.0 | 決済カード業界データセキュリティ基準 | カード情報取扱システム |
| FISC安全対策基準 | 金融情報システム安全対策基準 | 金融システム全般 |
| ISO 27001 | 情報セキュリティマネジメント | 組織全体 |

---

## 2. アクセス制御

### 2.1 IAM設計原則

| 原則 | 説明 |
|------|------|
| 最小権限 | 業務に必要な最小限の権限のみ付与 |
| 職務分離 | 開発者は本番環境への直接アクセス不可 |
| 一時的アクセス | 必要時のみアクセス権を付与（JIT） |
| 監査可能 | すべてのアクセスをログ記録 |

### 2.2 GCP IAM ロール設計

```yaml
# カスタムロール定義
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMCustomRole
metadata:
  name: payment-platform-developer
spec:
  title: "Payment Platform Developer"
  description: "Developer role for payment platform"
  stage: GA
  permissions:
    # GKE
    - container.clusters.get
    - container.pods.list
    - container.pods.getLogs
    # Cloud SQL（読み取りのみ）
    - cloudsql.instances.get
    - cloudsql.databases.list
    # Logging
    - logging.logEntries.list
    - logging.logs.list
  # 明示的に除外
  # - container.pods.exec  # 本番Pod実行不可
  # - cloudsql.instances.update  # DB設定変更不可
```

### 2.3 本番環境アクセス制御

| 役割 | 通常時 | インシデント時 |
|------|--------|--------------|
| 開発者 | 読み取りのみ | 一時的な操作権限（承認必要） |
| SRE | 読み取り + 限定操作 | フル操作権限 |
| DBA | DB読み取りのみ | DB操作権限 |
| Security | 監査ログ参照 | フルアクセス |

### 2.4 特権アクセス管理（PAM）

```bash
# Just-In-Time アクセス申請（例：Teleport/HashiCorp Boundary）

# 1. アクセス申請
access-request create \
  --role=production-admin \
  --reason="インシデント対応: INC-12345" \
  --duration=2h

# 2. 承認後のアクセス
access-request approve <request-id>

# 3. アクセスログ確認
access-audit list --user=<user> --start=2026-01-01
```

---

## 3. ネットワークセキュリティ

### 3.1 ネットワーク分離

```
┌─────────────────────────────────────────────────────────────────┐
│                         Internet                                 │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                    ┌─────────▼─────────┐
                    │   Cloud Armor     │ ← WAF/DDoS対策
                    │   (WAF Rules)     │
                    └─────────┬─────────┘
                              │
                    ┌─────────▼─────────┐
                    │   Load Balancer   │ ← TLS終端
                    │   (HTTPS only)    │
                    └─────────┬─────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────┐
│  VPC: payment-platform      │                                    │
│                    ┌────────▼────────┐                          │
│                    │   GKE Cluster   │ ← プライベートクラスター │
│                    │   (Private)     │                          │
│                    └────────┬────────┘                          │
│                             │                                    │
│  ┌──────────────────────────┼──────────────────────────────┐    │
│  │  Private Subnet          │                              │    │
│  │                 ┌────────▼────────┐                     │    │
│  │                 │   Cloud SQL     │ ← プライベートIP    │    │
│  │                 │   (Private IP)  │                     │    │
│  │                 └─────────────────┘                     │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Cloud Armor WAFルール

```yaml
# セキュリティポリシー
resource "google_compute_security_policy" "payment_policy" {
  name = "payment-security-policy"

  # OWASP ModSecurity Core Rule Set
  rule {
    action   = "deny(403)"
    priority = 1000
    match {
      expr {
        expression = "evaluatePreconfiguredExpr('sqli-stable')"
      }
    }
    description = "SQL Injection protection"
  }

  rule {
    action   = "deny(403)"
    priority = 1001
    match {
      expr {
        expression = "evaluatePreconfiguredExpr('xss-stable')"
      }
    }
    description = "XSS protection"
  }

  # レート制限
  rule {
    action   = "throttle"
    priority = 2000
    match {
      versioned_expr = "SRC_IPS_V1"
      config {
        src_ip_ranges = ["*"]
      }
    }
    rate_limit_options {
      conform_action = "allow"
      exceed_action  = "deny(429)"
      rate_limit_threshold {
        count        = 1000
        interval_sec = 60
      }
    }
    description = "Rate limiting"
  }

  # Geo制限（日本のみ許可の例）
  rule {
    action   = "deny(403)"
    priority = 3000
    match {
      expr {
        expression = "origin.region_code != 'JP'"
      }
    }
    description = "Geo restriction - Japan only"
  }
}
```

### 3.3 NetworkPolicy（Kubernetes）

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: payment-api-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: payment-api
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Istio Ingress Gatewayからのみ許可
    - from:
        - namespaceSelector:
            matchLabels:
              name: istio-system
        - podSelector:
            matchLabels:
              app: istio-ingressgateway
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # DBへのアクセス
    - to:
        - ipBlock:
            cidr: 10.0.16.0/24  # DB subnet
      ports:
        - protocol: TCP
          port: 5432
    # Redis
    - to:
        - ipBlock:
            cidr: 10.0.17.0/24  # Cache subnet
      ports:
        - protocol: TCP
          port: 6379
    # DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
```

---

## 4. データ保護

### 4.1 暗号化要件

| データ状態 | 暗号化方式 | 鍵管理 |
|-----------|----------|--------|
| 保存時（At Rest） | AES-256 | Cloud KMS (CMEK) |
| 転送時（In Transit） | TLS 1.3 | Certificate Manager |
| 使用時（In Use） | アプリケーション暗号化 | Cloud KMS |

### 4.2 Cloud KMS設定

```bash
# 暗号化鍵の作成
gcloud kms keyrings create payment-keyring \
  --location=asia-northeast1

gcloud kms keys create payment-data-key \
  --location=asia-northeast1 \
  --keyring=payment-keyring \
  --purpose=encryption \
  --rotation-period=90d \
  --next-rotation-time=$(date -u +"%Y-%m-%dT%H:%M:%SZ" -d "+90 days")

# 鍵へのアクセス権限設定
gcloud kms keys add-iam-policy-binding payment-data-key \
  --location=asia-northeast1 \
  --keyring=payment-keyring \
  --member="serviceAccount:payment-api@project.iam.gserviceaccount.com" \
  --role="roles/cloudkms.cryptoKeyEncrypterDecrypter"
```

### 4.3 機密データの取り扱い

| データ種別 | 保存 | 表示 | ログ出力 |
|-----------|------|------|---------|
| カード番号（PAN） | トークン化必須 | マスキング必須 | 禁止 |
| CVV/CVC | 保存禁止 | 入力時のみ表示 | 禁止 |
| 口座番号 | 暗号化必須 | マスキング必須 | 禁止 |
| 個人情報（PII） | 暗号化推奨 | 必要時のみ | マスキング |

### 4.4 データマスキング実装例

```go
// マスキング関数
func MaskPAN(pan string) string {
    if len(pan) < 13 {
        return "****"
    }
    return pan[:6] + "******" + pan[len(pan)-4:]
}

// ログ出力時の自動マスキング
type SecureLogger struct {
    logger *log.Logger
}

func (l *SecureLogger) Info(msg string, fields map[string]interface{}) {
    // センシティブフィールドをマスキング
    sensitiveFields := []string{"pan", "card_number", "account_number", "cvv"}
    for _, field := range sensitiveFields {
        if val, ok := fields[field]; ok {
            fields[field] = MaskSensitiveData(fmt.Sprintf("%v", val))
        }
    }
    l.logger.Println(msg, fields)
}
```

---

## 5. シークレット管理

### 5.1 Secret Manager利用

```bash
# シークレット作成
echo -n "db_password_value" | gcloud secrets create payment-db-password \
  --data-file=- \
  --replication-policy="user-managed" \
  --locations="asia-northeast1"

# バージョン管理
gcloud secrets versions add payment-db-password --data-file=new_password.txt

# アクセス権限設定
gcloud secrets add-iam-policy-binding payment-db-password \
  --member="serviceAccount:payment-api@project.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"
```

### 5.2 Kubernetes External Secrets

```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: payment-secrets
  namespace: production
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcp-secret-manager
    kind: ClusterSecretStore
  target:
    name: payment-secrets
    creationPolicy: Owner
  data:
    - secretKey: db-password
      remoteRef:
        key: payment-db-password
        version: latest
    - secretKey: api-key
      remoteRef:
        key: payment-api-key
        version: latest
```

### 5.3 シークレットローテーション

| シークレット種別 | ローテーション頻度 | 方法 |
|----------------|------------------|------|
| DBパスワード | 90日 | Secret Manager + 自動更新 |
| APIキー | 30日 | Secret Manager + 自動更新 |
| TLS証明書 | 自動（Let's Encrypt） | cert-manager |
| サービスアカウントキー | 使用しない | Workload Identity推奨 |

---

## 6. 脆弱性管理

### 6.1 コンテナイメージスキャン

```yaml
# GitHub Actions - Trivy スキャン
- name: Run Trivy vulnerability scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: ${{ env.IMAGE_TAG }}
    format: 'sarif'
    output: 'trivy-results.sarif'
    severity: 'CRITICAL,HIGH'
    exit-code: '1'  # Critical/High があればビルド失敗
```

### 6.2 Artifact Registry 脆弱性スキャン

```bash
# 脆弱性スキャン有効化
gcloud artifacts repositories update payment-repo \
  --location=asia-northeast1 \
  --enable-vulnerability-scanning

# スキャン結果確認
gcloud artifacts docker images list asia-northeast1-docker.pkg.dev/project/payment-repo \
  --include-tags \
  --show-occurrences
```

### 6.3 脆弱性対応基準

| 重要度 | 対応期限 | 対応方法 |
|--------|---------|---------|
| Critical | 24時間以内 | 即時パッチ適用 or サービス停止検討 |
| High | 7日以内 | パッチ適用 |
| Medium | 30日以内 | 定期メンテナンスで対応 |
| Low | 90日以内 | 次回リリースで対応 |

---

## 7. 監査ログ

### 7.1 ログ収集対象

| ログ種別 | 収集先 | 保持期間 |
|---------|--------|---------|
| Cloud Audit Logs | Cloud Logging | 400日 |
| GKE監査ログ | Cloud Logging | 400日 |
| アプリケーションログ | Cloud Logging | 90日 |
| アクセスログ | BigQuery | 7年 |
| 決済トランザクションログ | BigQuery | 7年 |

### 7.2 監査ログクエリ例

```sql
-- 特権操作の監査（BigQuery）
SELECT
  timestamp,
  protopayload_auditlog.authenticationInfo.principalEmail as user,
  protopayload_auditlog.methodName as action,
  protopayload_auditlog.resourceName as resource
FROM
  `project.audit_logs.cloudaudit_googleapis_com_activity_*`
WHERE
  _TABLE_SUFFIX BETWEEN '20260101' AND '20260131'
  AND protopayload_auditlog.methodName LIKE '%delete%'
ORDER BY timestamp DESC
LIMIT 100;

-- 不審なアクセスパターン検出
SELECT
  jsonPayload.user_id,
  jsonPayload.ip_address,
  COUNT(*) as request_count,
  COUNT(DISTINCT jsonPayload.ip_address) as unique_ips
FROM
  `project.logs.payment_api_*`
WHERE
  _TABLE_SUFFIX = FORMAT_DATE('%Y%m%d', CURRENT_DATE())
GROUP BY
  jsonPayload.user_id, jsonPayload.ip_address
HAVING
  request_count > 1000 OR unique_ips > 10
ORDER BY request_count DESC;
```

### 7.3 リアルタイムアラート

```yaml
# Cloud Monitoring アラートポリシー
resource "google_monitoring_alert_policy" "suspicious_activity" {
  display_name = "Suspicious Activity Alert"
  combiner     = "OR"
  conditions {
    display_name = "High rate of failed logins"
    condition_threshold {
      filter          = "resource.type=\"k8s_container\" AND jsonPayload.event_type=\"login_failed\""
      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 100
      aggregations {
        alignment_period   = "60s"
        per_series_aligner = "ALIGN_RATE"
      }
    }
  }
  notification_channels = [google_monitoring_notification_channel.security_team.id]
}
```

---

## 8. インシデント対応

### 8.1 セキュリティインシデント分類

| 分類 | 例 | 対応レベル |
|------|-----|----------|
| 侵害 | 不正アクセス、データ漏洩 | Critical - 即時対応 |
| 攻撃 | DDoS、SQLインジェクション試行 | High - 30分以内 |
| 脆弱性 | ゼロデイ脆弱性発見 | High - 評価後対応 |
| 違反 | ポリシー違反、不正操作 | Medium - 調査対応 |

### 8.2 セキュリティインシデント対応フロー

```
1. 検知・報告
   ↓
2. 初動対応（15分以内）
   - 影響範囲の特定
   - 証拠保全
   - 封じ込め（必要に応じてサービス停止）
   ↓
3. エスカレーション
   - Security Team
   - 経営層（重大インシデントの場合）
   - 法務・コンプライアンス
   ↓
4. 調査・分析
   - ログ分析
   - フォレンジック
   ↓
5. 復旧
   - システム復旧
   - 再発防止策実施
   ↓
6. 報告
   - インシデントレポート作成
   - 必要に応じて監督官庁への報告
```

### 8.3 緊急連絡先

| 役割 | 連絡先 | 連絡手段 |
|------|--------|---------|
| Security Team | security@example.com | Email + Slack #security-urgent |
| CISO | [電話番号] | 電話（Critical時） |
| 法務 | legal@example.com | Email |
| 広報 | pr@example.com | Email |

---

## 9. コンプライアンス

### 9.1 PCI DSS要件マッピング

| 要件 | 内容 | 対応状況 |
|------|------|---------|
| 1 | ファイアウォール設置 | Cloud Armor + NetworkPolicy |
| 2 | デフォルトパスワード変更 | Secret Manager で管理 |
| 3 | カード会員データ保護 | トークン化 + 暗号化 |
| 4 | 暗号化による通信保護 | TLS 1.3 |
| 5 | マルウェア対策 | コンテナスキャン |
| 6 | システム脆弱性管理 | 定期スキャン + パッチ管理 |
| 7 | アクセス制御 | IAM + RBAC |
| 8 | ユーザー識別・認証 | MFA必須 |
| 9 | 物理アクセス制限 | GCP管理 |
| 10 | ネットワーク監視 | Cloud Logging + SIEM |
| 11 | セキュリティテスト | 年次ペネトレーションテスト |
| 12 | 情報セキュリティポリシー | 本ドキュメント + 社内規定 |

### 9.2 定期レビュー

| 項目 | 頻度 | 担当 |
|------|------|------|
| アクセス権レビュー | 四半期 | Security Team |
| 脆弱性スキャン | 週次 | 自動実行 |
| ペネトレーションテスト | 年次 | 外部ベンダー |
| コンプライアンス監査 | 年次 | 監査法人 |

---

## 10. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2026-01-XX | 1.0 | 初版作成 | - |
