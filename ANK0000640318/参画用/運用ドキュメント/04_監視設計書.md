# 監視設計書

## 1. 概要

### 1.1 目的
本ドキュメントは、金融決済プラットフォームの監視・オブザーバビリティ設計を定義する。

### 1.2 SLI/SLO定義

| サービス | SLI | SLO | 測定方法 |
|---------|-----|-----|----------|
| Payment API | 可用性 | 99.99% | 成功リクエスト / 総リクエスト |
| Payment API | レイテンシ（P99） | < 100ms | Prometheus histogram |
| Batch Processing | 完了率 | 99.9% | 成功バッチ / 総バッチ |
| Database | 接続成功率 | 99.999% | 成功接続 / 総接続試行 |

### 1.3 エラーバジェット

```
月間エラーバジェット = (1 - SLO) × 月間総分
例: Payment API (SLO 99.99%)
   = (1 - 0.9999) × 43,200分（30日）
   = 4.32分/月
```

---

## 2. 監視アーキテクチャ

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Monitoring Architecture                          │
│                                                                       │
│  ┌─────────────────┐     ┌─────────────────┐     ┌───────────────┐  │
│  │  Application    │────>│   Prometheus    │────>│    Grafana    │  │
│  │  Metrics        │     │   (Scrape)      │     │  (Dashboard)  │  │
│  └─────────────────┘     └────────┬────────┘     └───────────────┘  │
│                                   │                                   │
│  ┌─────────────────┐     ┌────────▼────────┐     ┌───────────────┐  │
│  │  Application    │────>│  Cloud Logging  │────>│   BigQuery    │  │
│  │  Logs           │     │  (Aggregation)  │     │  (Analysis)   │  │
│  └─────────────────┘     └─────────────────┘     └───────────────┘  │
│                                                                       │
│  ┌─────────────────┐     ┌─────────────────┐     ┌───────────────┐  │
│  │  Cloud Trace    │────>│   Trace         │────>│   Service     │  │
│  │  (APM)          │     │   Analysis      │     │   Map         │  │
│  └─────────────────┘     └─────────────────┘     └───────────────┘  │
│                                                                       │
│  ┌─────────────────┐     ┌─────────────────┐     ┌───────────────┐  │
│  │  AlertManager   │────>│   PagerDuty     │────>│   Slack       │  │
│  │  (Routing)      │     │   (Escalation)  │     │  (Notify)     │  │
│  └─────────────────┘     └─────────────────┘     └───────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 使用ツール

| カテゴリ | ツール | 用途 |
|---------|--------|------|
| メトリクス収集 | Prometheus | アプリ・インフラメトリクス |
| メトリクス収集 | Cloud Monitoring | GCPサービスメトリクス |
| 可視化 | Grafana | ダッシュボード |
| ログ収集 | Cloud Logging | ログ集約・検索 |
| ログ分析 | BigQuery | 長期ログ分析 |
| トレーシング | Cloud Trace | 分散トレーシング |
| アラート | AlertManager + PagerDuty | 通知・エスカレーション |

---

## 3. メトリクス設計

### 3.1 RED メトリクス（サービス指標）

| メトリクス | 説明 | PromQL |
|-----------|------|--------|
| **R**ate | リクエストレート | `sum(rate(http_requests_total[5m]))` |
| **E**rrors | エラー率 | `sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))` |
| **D**uration | レイテンシ | `histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))` |

### 3.2 USE メトリクス（リソース指標）

| メトリクス | 説明 | PromQL |
|-----------|------|--------|
| **U**tilization | CPU使用率 | `avg(rate(container_cpu_usage_seconds_total[5m])) / avg(kube_pod_container_resource_limits{resource="cpu"})` |
| **S**aturation | メモリ飽和度 | `container_memory_working_set_bytes / container_spec_memory_limit_bytes` |
| **E**rrors | OOMKill数 | `increase(kube_pod_container_status_restarts_total{reason="OOMKilled"}[1h])` |

### 3.3 ビジネスメトリクス

| メトリクス名 | 型 | 説明 | ラベル |
|-------------|-----|------|--------|
| payment_transactions_total | Counter | 決済トランザクション数 | status, type |
| payment_amount_total | Counter | 決済金額合計 | currency |
| payment_processing_duration_seconds | Histogram | 決済処理時間 | type |
| active_sessions | Gauge | アクティブセッション数 | - |

### 3.4 Prometheus設定

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: payment-prod-gke
    env: production

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

rule_files:
  - /etc/prometheus/rules/*.yml

scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+)
        replacement: ${1}

  - job_name: 'kubernetes-services'
    kubernetes_sd_configs:
      - role: service
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true

  - job_name: 'gcp-cloud-sql'
    static_configs:
      - targets: ['cloud-sql-exporter:9187']

  - job_name: 'istio-mesh'
    kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
            - istio-system
```

---

## 4. ログ設計

### 4.1 ログレベル定義

| レベル | 用途 | 例 |
|--------|------|-----|
| ERROR | 即座に対応が必要 | 決済失敗、DB接続エラー |
| WARN | 注意が必要 | リトライ発生、遅延検知 |
| INFO | 正常な業務処理 | 決済完了、API呼び出し |
| DEBUG | 開発用（本番無効） | 変数値、詳細処理 |

### 4.2 構造化ログフォーマット

```json
{
  "timestamp": "2026-01-15T10:30:00.000Z",
  "severity": "INFO",
  "logger": "payment.api",
  "message": "Payment processed successfully",
  "trace_id": "abc123xyz",
  "span_id": "def456",
  "request_id": "req-001",
  "transaction_id": "txn-12345",
  "user_id": "user-123",
  "merchant_id": "merchant-456",
  "method": "POST",
  "path": "/api/v1/payments",
  "status_code": 200,
  "duration_ms": 85,
  "payment": {
    "amount": 10000,
    "currency": "JPY",
    "type": "credit_card"
  }
}
```

### 4.3 Cloud Logging クエリ例

```
# エラーログ検索
severity="ERROR"
resource.type="k8s_container"
resource.labels.namespace_name="production"

# 決済エラー検索
jsonPayload.logger="payment.api"
jsonPayload.status_code>=400
jsonPayload.payment.amount>0

# レイテンシ分析
jsonPayload.duration_ms>100
| timestamp, jsonPayload.path, jsonPayload.duration_ms
| ORDER BY jsonPayload.duration_ms DESC
| LIMIT 100

# トランザクション追跡
jsonPayload.transaction_id="txn-12345"
```

---

## 5. アラート設計

### 5.1 アラートルール

```yaml
# alert_rules.yml
groups:
  - name: payment-api-alerts
    rules:
      # 高エラー率（Critical）
      - alert: PaymentAPIHighErrorRate
        expr: |
          sum(rate(http_requests_total{job="payment-api",status=~"5.."}[5m])) /
          sum(rate(http_requests_total{job="payment-api"}[5m])) > 0.001
        for: 2m
        labels:
          severity: critical
          team: platform
          service: payment-api
        annotations:
          summary: "Payment API error rate > 0.1%"
          description: "Current error rate: {{ $value | humanizePercentage }}"
          runbook_url: "https://wiki.example.com/runbooks/payment-api-errors"

      # 高レイテンシ（Warning）
      - alert: PaymentAPIHighLatency
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket{job="payment-api"}[5m])) by (le)
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          team: platform
          service: payment-api
        annotations:
          summary: "Payment API P99 latency > 100ms"
          description: "P99 latency: {{ $value | humanizeDuration }}"

      # 決済失敗率（Critical）
      - alert: PaymentFailureRateHigh
        expr: |
          sum(rate(payment_transactions_total{status="failed"}[5m])) /
          sum(rate(payment_transactions_total[5m])) > 0.01
        for: 2m
        labels:
          severity: critical
          team: payment
          service: payment-processor
        annotations:
          summary: "Payment failure rate > 1%"
          description: "Failure rate: {{ $value | humanizePercentage }}"
          runbook_url: "https://wiki.example.com/runbooks/payment-failures"

  - name: infrastructure-alerts
    rules:
      # Pod再起動（Warning）
      - alert: PodRestartingTooMuch
        expr: |
          increase(kube_pod_container_status_restarts_total{namespace="production"}[1h]) > 3
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Pod {{ $labels.pod }} restarting frequently"

      # メモリ使用率（Warning）
      - alert: PodMemoryUsageHigh
        expr: |
          container_memory_working_set_bytes{namespace="production"} /
          container_spec_memory_limit_bytes{namespace="production"} > 0.9
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Pod {{ $labels.pod }} memory usage > 90%"

      # DB接続エラー（Critical）
      - alert: DatabaseConnectionErrors
        expr: |
          increase(pg_stat_activity_count{state="idle in transaction (aborted)"}[5m]) > 5
        for: 2m
        labels:
          severity: critical
          team: platform
          service: database
        annotations:
          summary: "Database connection errors detected"
          runbook_url: "https://wiki.example.com/runbooks/db-connection-errors"
```

### 5.2 アラート重要度とエスカレーション

| Severity | 対応時間 | 通知先 | 例 |
|----------|---------|--------|-----|
| critical | 5分以内 | PagerDuty → 電話 + Slack | サービス停止、決済失敗 |
| warning | 30分以内 | Slack #alerts | レイテンシ上昇、リソース逼迫 |
| info | 翌営業日 | Slack #info | 情報通知、メンテナンス |

### 5.3 AlertManager設定

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m
  slack_api_url: 'https://hooks.slack.com/services/xxx'
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

route:
  receiver: 'default'
  group_by: ['alertname', 'severity', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  routes:
    # Critical → PagerDuty + Slack
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      continue: true

    # Warning → Slack
    - match:
        severity: warning
      receiver: 'slack-warning'

    # Payment Team専用
    - match:
        team: payment
      receiver: 'payment-team'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service']

receivers:
  - name: 'default'
    slack_configs:
      - channel: '#alerts'
        send_resolved: true
        title: '{{ .Status | toUpper }}: {{ .CommonAnnotations.summary }}'
        text: '{{ .CommonAnnotations.description }}'

  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '<pagerduty-integration-key>'
        severity: critical
        description: '{{ .CommonAnnotations.summary }}'
        details:
          service: '{{ .CommonLabels.service }}'
          runbook: '{{ .CommonAnnotations.runbook_url }}'
    slack_configs:
      - channel: '#alerts-critical'
        send_resolved: true

  - name: 'slack-warning'
    slack_configs:
      - channel: '#alerts-warning'
        send_resolved: true

  - name: 'payment-team'
    slack_configs:
      - channel: '#payment-alerts'
        send_resolved: true
    email_configs:
      - to: 'payment-team@example.com'
```

---

## 6. ダッシュボード設計

### 6.1 ダッシュボード一覧

| ダッシュボード | 対象者 | 主要指標 |
|---------------|--------|----------|
| Executive Summary | 経営層 | SLO達成率、可用性、決済金額 |
| Service Overview | SRE | リクエスト数、エラー率、レイテンシ |
| Payment Details | 決済チーム | 決済成功率、失敗理由、処理時間 |
| Infrastructure | インフラ | CPU/メモリ、Pod数、ノード状態 |
| Database | DBA | 接続数、クエリ性能、レプリケーション |

### 6.2 SREダッシュボード構成

```
┌─────────────────────────────────────────────────────────────────┐
│                     Payment Platform Overview                    │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │ Availability│ │Error Budget │ │   Latency   │ │ Throughput│ │
│  │   99.995%   │ │  85% left   │ │  P99: 45ms  │ │  2.5k/s   │ │
│  │  ✓ SLO Met  │ │  3.67 min   │ │  ✓ SLO Met  │ │           │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  Payment Transactions           │  Payment Failures              │
│  [Graph: Success/Failed/Total]  │  [Graph: By Reason]            │
│  - Success: 99.2%               │  - Timeout: 0.3%               │
│  - Failed: 0.8%                 │  - Invalid: 0.4%               │
│                                 │  - Provider: 0.1%              │
├─────────────────────────────────────────────────────────────────┤
│  Request Rate (5m avg)          │  Latency Distribution          │
│  [Graph: 24h trend]             │  [Histogram: P50/P90/P99]      │
├─────────────────────────────────────────────────────────────────┤
│  Active Alerts                  │  Recent Deployments            │
│  - CRITICAL: 0                  │  - v1.2.3 @ 10:30              │
│  - WARNING: 1                   │  - v1.2.2 @ 09:15              │
│  - INFO: 3                      │  - v1.2.1 @ Yesterday          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 分散トレーシング

### 7.1 Cloud Trace 設定

```go
// Go example with OpenTelemetry
import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/trace/cloud"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
)

func initTracer() {
    exporter, _ := cloud.NewExporter(cloud.WithProjectID("project-id"))
    tp := sdktrace.NewTracerProvider(
        sdktrace.WithBatcher(exporter),
        sdktrace.WithSampler(sdktrace.AlwaysSample()),
    )
    otel.SetTracerProvider(tp)
}
```

### 7.2 トレース分析ポイント

| 分析観点 | 確認項目 |
|---------|---------|
| ボトルネック | 各サービスの処理時間 |
| 障害箇所 | エラー発生サービス |
| 依存関係 | サービス間の呼び出し |
| N+1問題 | DB呼び出し回数 |

---

## 8. オンコール運用

### 8.1 オンコールローテーション

| 曜日 | Primary | Secondary |
|------|---------|-----------|
| 月-金 | チームA | チームB |
| 土-日 | チームB | チームA |

### 8.2 エスカレーションフロー

```
1. アラート発報
   ↓
2. Primary (5分)
   - 応答なし → Secondary へ
   ↓
3. Secondary (5分)
   - 応答なし → Manager へ
   ↓
4. Manager (5分)
   - 応答なし → VP へ
```

### 8.3 インシデント対応チェックリスト

- [ ] 影響範囲の特定
- [ ] ステータスページ更新
- [ ] 関係者への連絡
- [ ] 一時対応の実施
- [ ] 根本原因の調査
- [ ] 恒久対応の計画
- [ ] ポストモーテム作成

---

## 9. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2026-01-XX | 1.0 | 初版作成 | - |
