# インフラ設計書

## 1. 概要

### 1.1 目的
本ドキュメントは、金融決済プラットフォームのインフラ設計を定義する。

### 1.2 対象システム
- **システム名**: [プロダクト名]
- **環境**: Production / Staging / Development
- **リージョン**: asia-northeast1（東京）/ ap-northeast-1（東京）

### 1.3 設計原則
- マルチクラウド対応（GCP + AWS）
- 高可用性（99.99%以上）
- PCI DSS準拠
- コスト最適化

---

## 2. アーキテクチャ概要

### 2.1 システム構成図

```
                              ┌─────────────────────────────────────┐
                              │         Google Cloud Platform        │
┌──────────┐                  │  ┌─────────────────────────────┐    │
│  Users   │──── Internet ────│──│   Cloud Load Balancing      │    │
└──────────┘                  │  │   + Cloud Armor (WAF)       │    │
                              │  └──────────────┬──────────────┘    │
                              │                 │                    │
                              │  ┌──────────────▼──────────────┐    │
                              │  │     GKE Cluster (Autopilot) │    │
                              │  │  ┌─────┐ ┌─────┐ ┌─────┐    │    │
                              │  │  │ API │ │ Batch│ │Worker│   │    │
                              │  │  │ Pod │ │ Pod │ │ Pod │    │    │
                              │  │  └─────┘ └─────┘ └─────┘    │    │
                              │  └──────────────┬──────────────┘    │
                              │                 │                    │
                              │  ┌──────────────▼──────────────┐    │
                              │  │   Cloud SQL (PostgreSQL)    │    │
                              │  │      + Cloud Spanner        │    │
                              │  └─────────────────────────────┘    │
                              │                                      │
                              │  ┌─────────────┐ ┌─────────────┐    │
                              │  │   GCS       │ │  Artifact   │    │
                              │  │  (Storage)  │ │  Registry   │    │
                              │  └─────────────┘ └─────────────┘    │
                              └─────────────────────────────────────┘
```

### 2.2 環境構成

| 環境 | 用途 | VPC CIDR |
|------|------|----------|
| Production | 本番環境 | 10.0.0.0/16 |
| Staging | 検証環境 | 10.1.0.0/16 |
| Development | 開発環境 | 10.2.0.0/16 |

---

## 3. GCP ネットワーク設計

### 3.1 VPC設計

| 項目 | 設定値 |
|------|--------|
| VPC名 | payment-platform-vpc |
| サブネットモード | カスタム |
| ルーティングモード | グローバル |

### 3.2 サブネット設計

| サブネット | CIDR | リージョン | 用途 |
|-----------|------|-----------|------|
| gke-subnet | 10.0.0.0/20 | asia-northeast1 | GKEノード |
| db-subnet | 10.0.16.0/24 | asia-northeast1 | Cloud SQL |
| proxy-subnet | 10.0.17.0/24 | asia-northeast1 | プロキシ専用 |

### 3.3 ファイアウォールルール

| ルール名 | 方向 | アクション | ソース | ターゲット | ポート |
|---------|------|----------|--------|----------|--------|
| allow-https | Ingress | Allow | 0.0.0.0/0 | lb-tag | 443 |
| allow-health-check | Ingress | Allow | 130.211.0.0/22, 35.191.0.0/16 | all | 80,443 |
| allow-internal | Ingress | Allow | 10.0.0.0/16 | all | all |
| deny-all-ingress | Ingress | Deny | 0.0.0.0/0 | all | all |

---

## 4. GKE クラスター設計

### 4.1 クラスター構成

| 項目 | 設定値 |
|------|--------|
| クラスター名 | payment-prod-gke |
| モード | Autopilot |
| リリースチャンネル | Regular |
| リージョン | asia-northeast1 |
| ネットワーク | payment-platform-vpc |

### 4.2 セキュリティ設定

| 項目 | 設定値 |
|------|--------|
| Workload Identity | Enabled |
| Binary Authorization | Enabled |
| Shielded GKE Nodes | Enabled |
| プライベートクラスター | Enabled |
| マスター認可ネットワーク | 指定IPのみ |

### 4.3 Namespace設計

| Namespace | 用途 | リソースクォータ |
|-----------|------|-----------------|
| production | 本番アプリケーション | CPU: 20, Memory: 40Gi |
| batch | バッチ処理 | CPU: 10, Memory: 20Gi |
| monitoring | 監視系 | CPU: 4, Memory: 8Gi |
| istio-system | サービスメッシュ | CPU: 4, Memory: 8Gi |

---

## 5. データベース設計

### 5.1 Cloud SQL (PostgreSQL)

| 項目 | 設定値 |
|------|--------|
| インスタンス名 | payment-prod-db |
| データベースバージョン | PostgreSQL 15 |
| マシンタイプ | db-custom-4-16384 |
| 高可用性 | Regional (HA) |
| ストレージ | SSD, 100GB, 自動増加 |
| バックアップ | 自動（7日間保持） |
| ポイントインタイムリカバリ | Enabled |

### 5.2 Cloud Spanner（高可用性要件時）

| 項目 | 設定値 |
|------|--------|
| インスタンス名 | payment-spanner |
| 構成 | regional-asia-northeast1 |
| ノード数 | 3 |
| 用途 | グローバル分散が必要なトランザクション |

### 5.3 Memorystore (Redis)

| 項目 | 設定値 |
|------|--------|
| インスタンス名 | payment-cache |
| Tier | Standard (HA) |
| メモリ | 5GB |
| バージョン | Redis 7.0 |

---

## 6. セキュリティ設計

### 6.1 Cloud Armor（WAF）

| ルール | アクション | 優先度 | 説明 |
|--------|----------|--------|------|
| OWASP ModSecurity CRS | Deny | 1000 | OWASP Top 10対策 |
| SQLi防御 | Deny | 2000 | SQLインジェクション対策 |
| XSS防御 | Deny | 3000 | クロスサイトスクリプティング対策 |
| レート制限 | Throttle | 4000 | 1000 req/min |
| Geo制限 | Deny | 5000 | 許可国以外をブロック |

### 6.2 IAM設計

| 役割 | 権限 | 対象 |
|------|------|------|
| gke-workload-sa | roles/cloudsql.client | Cloud SQL接続 |
| gke-workload-sa | roles/storage.objectViewer | GCSアクセス |
| ci-cd-sa | roles/container.developer | GKEデプロイ |
| monitoring-sa | roles/monitoring.viewer | 監視データ参照 |

### 6.3 暗号化

| 対象 | 方式 |
|------|------|
| 保存データ | Customer-managed encryption keys (CMEK) |
| 通信 | TLS 1.3 |
| シークレット | Secret Manager |

---

## 7. 可用性・DR設計

### 7.1 可用性目標

| 項目 | 目標値 |
|------|--------|
| 可用性 | 99.99% |
| RPO (目標復旧時点) | 15分 |
| RTO (目標復旧時間) | 1時間 |

### 7.2 冗長化構成

| コンポーネント | 冗長化方式 |
|---------------|-----------|
| GKE | リージョナル（3ゾーン） |
| Cloud SQL | Regional HA（自動フェイルオーバー） |
| Cloud Load Balancing | グローバル分散 |
| Memorystore | Standard Tier（レプリカ） |

### 7.3 バックアップ戦略

| 対象 | 方式 | 頻度 | 保持期間 |
|------|------|------|----------|
| Cloud SQL | 自動バックアップ | 日次 | 30日 |
| Cloud SQL | PITR | 継続 | 7日 |
| GCS | バージョニング | リアルタイム | 90日 |
| GKE設定 | Velero | 日次 | 30日 |

---

## 8. AWS連携設計（マルチクラウド）

### 8.1 AWS側構成

| サービス | 用途 |
|---------|------|
| AWS Direct Connect | GCPとの専用線接続 |
| Amazon S3 | バックアップストレージ |
| AWS KMS | 暗号鍵管理（相互バックアップ） |

### 8.2 クラウド間接続

| 項目 | 設定値 |
|------|--------|
| 接続方式 | Cloud Interconnect + AWS Direct Connect |
| 帯域 | 10Gbps |
| 冗長化 | アクティブ/スタンバイ |

---

## 9. コスト見積もり

### 9.1 月額コスト概算（Production）

| サービス | 仕様 | 月額(USD) |
|---------|------|-----------|
| GKE Autopilot | vCPU 20, Memory 40GB | $800 |
| Cloud SQL | db-custom-4-16384 HA | $600 |
| Cloud Spanner | 3ノード | $2,000 |
| Memorystore | 5GB Standard | $200 |
| Cloud Load Balancing | グローバル | $50 |
| Cloud Armor | WAFルール | $100 |
| Cloud Storage | 500GB | $15 |
| **合計** | | **$3,765** |

### 9.2 コスト最適化施策

- [ ] Committed Use Discounts の検討
- [ ] GKE Autopilot によるリソース最適化
- [ ] コールドデータのArchive Storage移行
- [ ] 開発環境のスケジュール停止

---

## 10. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2026-01-XX | 1.0 | 初版作成 | - |
