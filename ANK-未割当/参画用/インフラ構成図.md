# AIアプリケーション インフラ構成図

## 📋 目次
- [1. 全体像（システムアーキテクチャ）](#1-全体像システムアーキテクチャ)
- [2. ネットワーク構成](#2-ネットワーク構成)
- [3. アプリケーション構成（EKS）](#3-アプリケーション構成eks)
- [4. データフロー](#4-データフロー)
- [5. CI/CDパイプライン](#5-cicdパイプライン)
- [6. セキュリティアーキテクチャ](#6-セキュリティアーキテクチャ)

---

## 1. 全体像（システムアーキテクチャ）

**概要**: 主要コンポーネントとその関係性を示すシンプルな全体図

```mermaid
graph TB
    subgraph "🔧 開発環境"
        DEV[👨‍💻 開発者]
        GH[🐙 GitHub]
    end

    subgraph "☁️ AWS Cloud"
        subgraph "🌐 エッジ層"
            ALB[⚖️ ALB<br/>ロードバランサー]
        end

        subgraph "🎯 アプリケーション層"
            EKS[⎈ Amazon EKS<br/>Kubernetesクラスター]
        end

        subgraph "💾 データ層"
            RDS[(🗄️ RDS/Aurora<br/>RDBMS)]
            DDB[(⚡ DynamoDB<br/>NoSQL)]
            S3[(📦 S3<br/>Data Lake)]
        end

        subgraph "🤖 AI/ML層"
            ML[🧠 AI Model<br/>推論サービス]
            PIPELINE[⚙️ Data Pipeline<br/>ETL処理]
        end
    end

    subgraph "📊 監視・運用"
        CW[📈 CloudWatch<br/>ログ・メトリクス]
        GRAF[📊 Grafana<br/>可視化]
    end

    DEV -->|1. コード push| GH
    GH -->|2. CI/CD| EKS
    ALB -->|3. ルーティング| EKS
    EKS -->|4. データ読み書き| RDS
    EKS -->|5. データ読み書き| DDB
    EKS -->|6. ファイル保存| S3
    PIPELINE -->|7. ETL処理| S3
    ML -->|8. 推論| EKS
    EKS -->|9. ログ送信| CW
    CW -->|10. 可視化| GRAF

    style DEV fill:#e1f5ff
    style GH fill:#181717,color:#fff
    style ALB fill:#ff9900,color:#fff
    style EKS fill:#326CE5,color:#fff
    style RDS fill:#527FFF,color:#fff
    style DDB fill:#4053D6,color:#fff
    style S3 fill:#569A31,color:#fff
    style ML fill:#FF6F61,color:#fff
    style PIPELINE fill:#017CEE,color:#fff
    style CW fill:#ff9900,color:#fff
    style GRAF fill:#F46800,color:#fff
```

**重要ポイント**:
- ✅ マルチAZ構成で高可用性を実現
- ✅ EKSでコンテナオーケストレーション
- ✅ データレイクにS3を使用
- ✅ AI/MLパイプラインを統合

---

## 2. ネットワーク構成

**概要**: VPC、サブネット、セキュリティグループの構成

```mermaid
graph TB
    subgraph "🌍 インターネット"
        USERS[👥 ユーザー]
    end

    subgraph "☁️ AWS VPC: 10.0.0.0/16"
        subgraph "🌐 Public Subnet<br/>10.0.1.0/24 & 10.0.2.0/24"
            ALB[⚖️ ALB]
            NAT[🚪 NAT Gateway]
        end

        subgraph "🔒 Private Subnet - App<br/>10.0.10.0/24 & 10.0.11.0/24"
            EKS_NODES[⎈ EKS Worker Nodes]
        end

        subgraph "🗄️ Private Subnet - Data<br/>10.0.20.0/24 & 10.0.21.0/24"
            RDS[(🗄️ RDS/Aurora)]
            DDB[(⚡ DynamoDB)]
        end

        subgraph "📦 S3 Endpoint"
            S3[📦 S3 Data Lake]
        end

        subgraph "🔐 セキュリティグループ"
            SG_ALB[ALB-SG<br/>Port: 443]
            SG_EKS[EKS-SG<br/>Port: 8080, 443]
            SG_RDS[RDS-SG<br/>Port: 5432/3306]
        end
    end

    USERS -->|HTTPS:443| ALB
    ALB -->|HTTP:8080| EKS_NODES
    EKS_NODES -->|DB接続| RDS
    EKS_NODES -->|API接続| DDB
    EKS_NODES -->|VPC Endpoint| S3
    EKS_NODES -->|インターネット| NAT

    SG_ALB -.->|制御| ALB
    SG_EKS -.->|制御| EKS_NODES
    SG_RDS -.->|制御| RDS

    style USERS fill:#e1f5ff
    style ALB fill:#ff9900,color:#fff
    style NAT fill:#ff9900,color:#fff
    style EKS_NODES fill:#326CE5,color:#fff
    style RDS fill:#527FFF,color:#fff
    style DDB fill:#4053D6,color:#fff
    style S3 fill:#569A31,color:#fff
    style SG_ALB fill:#FF6B6B,color:#fff
    style SG_EKS fill:#FF6B6B,color:#fff
    style SG_RDS fill:#FF6B6B,color:#fff
```

**セキュリティ設定**:

| リソース | 送信元 | プロトコル/ポート | 説明 |
|---------|-------|----------------|------|
| ALB | 0.0.0.0/0 | HTTPS/443 | インターネットから受信 |
| EKS Nodes | ALB-SG | HTTP/8080 | ALBからのみ受信 |
| RDS | EKS-SG | TCP/5432 or 3306 | EKSからのみ接続 |
| DynamoDB | EKS-SG | HTTPS/443 | VPC Endpoint経由 |

---

## 3. アプリケーション構成（EKS）

**概要**: Kubernetesクラスター内のアプリケーション構成

```mermaid
graph TB
    subgraph "⎈ Amazon EKS Cluster"
        subgraph "🎯 Namespace: production"
            DEPLOY_APP[📦 Deployment<br/>Web Application]
            DEPLOY_API[📦 Deployment<br/>API Server]
            SVC_APP[🔌 Service<br/>app-service]
            SVC_API[🔌 Service<br/>api-service]
        end

        subgraph "🤖 Namespace: ai-inference"
            DEPLOY_ML[📦 Deployment<br/>ML Inference]
            SVC_ML[🔌 Service<br/>ml-service]
        end

        subgraph "⚙️ Namespace: data-pipeline"
            AIRFLOW[🔄 StatefulSet<br/>Airflow]
            JOBS[⚡ CronJob<br/>ETL Jobs]
        end

        subgraph "🛠️ Namespace: system"
            INGRESS[🌐 Ingress Controller<br/>ALB Ingress]
            CERT[🔐 Cert Manager]
            MONITOR[📊 Prometheus<br/>Grafana]
        end
    end

    subgraph "💾 外部リソース"
        ALB[⚖️ ALB]
        RDS[(🗄️ RDS)]
        S3[(📦 S3)]
    end

    ALB -->|ルーティング| INGRESS
    INGRESS -->|転送| SVC_APP
    INGRESS -->|転送| SVC_API
    SVC_APP -->|Pod通信| DEPLOY_APP
    SVC_API -->|Pod通信| DEPLOY_API

    DEPLOY_APP -->|API呼び出し| SVC_API
    DEPLOY_API -->|推論リクエスト| SVC_ML
    SVC_ML -->|Pod通信| DEPLOY_ML

    DEPLOY_API -->|DB接続| RDS
    AIRFLOW -->|オーケストレーション| JOBS
    JOBS -->|ETL処理| S3
    DEPLOY_ML -->|モデルロード| S3

    CERT -.->|SSL証明書管理| INGRESS
    MONITOR -.->|メトリクス収集| DEPLOY_APP
    MONITOR -.->|メトリクス収集| DEPLOY_API
    MONITOR -.->|メトリクス収集| DEPLOY_ML

    style DEPLOY_APP fill:#326CE5,color:#fff
    style DEPLOY_API fill:#326CE5,color:#fff
    style DEPLOY_ML fill:#FF6F61,color:#fff
    style AIRFLOW fill:#017CEE,color:#fff
    style INGRESS fill:#FFA500,color:#fff
    style MONITOR fill:#F46800,color:#fff
    style ALB fill:#ff9900,color:#fff
    style RDS fill:#527FFF,color:#fff
    style S3 fill:#569A31,color:#fff
```

**Kubernetesリソース構成**:

| Namespace | リソース | レプリカ数 | リソース要求 | 説明 |
|-----------|----------|-----------|-------------|------|
| production | app-deployment | 3 | CPU: 500m, Mem: 1Gi | Webアプリケーション |
| production | api-deployment | 3 | CPU: 1, Mem: 2Gi | APIサーバー |
| ai-inference | ml-deployment | 2 | CPU: 2, Mem: 4Gi | AI推論サービス |
| data-pipeline | airflow-statefulset | 1 | CPU: 1, Mem: 2Gi | ワークフローオーケストレーション |

---

## 4. データフロー

**概要**: データの流れを時系列で表現

```mermaid
graph LR
    subgraph "📥 データソース"
        IOT[🌡️ IoTデバイス<br/>センサーデータ]
        API_EXT[🌐 外部API<br/>公共データ]
        USER[👤 ユーザー<br/>アプリデータ]
    end

    subgraph "🔄 データ取り込み"
        KINESIS[📊 Kinesis<br/>ストリーム処理]
        S3_RAW[📦 S3 Raw Bucket<br/>生データ]
    end

    subgraph "⚙️ データ処理"
        AIRFLOW[🔄 Airflow<br/>オーケストレーション]

        ETL1[⚡ Extract Job<br/>データ収集]
        ETL2[⚡ Transform Job<br/>データ変換]
        ETL3[⚡ Load Job<br/>データロード]

        QUALITY[✅ Quality Check<br/>検証]
    end

    subgraph "💾 データストレージ"
        S3_PROC[📦 S3 Processed<br/>加工済みデータ]
        FEATURE[🎯 Feature Store<br/>DynamoDB]
        DWH[(📊 Data Warehouse<br/>Redshift/Aurora)]
    end

    subgraph "🤖 AI/ML"
        TRAIN[🎓 Model Training<br/>学習パイプライン]
        MODEL_REG[📚 Model Registry<br/>モデル管理]
        INFERENCE[🧠 Inference Service<br/>推論API]
    end

    subgraph "📱 アプリケーション"
        APP[📱 Web/Mobile App]
    end

    IOT -->|リアルタイム| KINESIS
    API_EXT -->|バッチ| S3_RAW
    USER -->|バッチ| S3_RAW

    KINESIS -->|トリガー| AIRFLOW
    S3_RAW -->|トリガー| AIRFLOW

    AIRFLOW -->|1. 実行| ETL1
    ETL1 -->|2. 生データ| ETL2
    ETL2 -->|3. 変換データ| QUALITY
    QUALITY -->|4. 検証OK| ETL3
    ETL3 -->|5. 格納| S3_PROC
    ETL3 -->|6. 特徴量| FEATURE
    ETL3 -->|7. 集計| DWH

    S3_PROC -->|学習データ| TRAIN
    FEATURE -->|特徴量| TRAIN
    TRAIN -->|モデル保存| MODEL_REG
    MODEL_REG -->|モデルデプロイ| INFERENCE

    FEATURE -->|リアルタイム特徴量| INFERENCE
    INFERENCE -->|推論結果| APP
    DWH -->|分析データ| APP

    style IOT fill:#FFB6C1
    style KINESIS fill:#FF9900,color:#fff
    style AIRFLOW fill:#017CEE,color:#fff
    style ETL1 fill:#4CAF50,color:#fff
    style ETL2 fill:#4CAF50,color:#fff
    style ETL3 fill:#4CAF50,color:#fff
    style QUALITY fill:#FFC107
    style S3_PROC fill:#569A31,color:#fff
    style FEATURE fill:#4053D6,color:#fff
    style TRAIN fill:#FF6F61,color:#fff
    style INFERENCE fill:#FF6F61,color:#fff
    style APP fill:#326CE5,color:#fff
```

**データフロー段階**:

1. **取り込み**: IoTデバイス → Kinesis / 外部API → S3
2. **処理**: Airflow → ETL Jobs → Quality Check
3. **格納**: S3 Processed / Feature Store / Data Warehouse
4. **AI/ML**: 学習 → モデル登録 → 推論
5. **活用**: アプリケーションで利用

---

## 5. CI/CDパイプライン

**概要**: 開発からデプロイまでの自動化フロー

```mermaid
graph TB
    subgraph "👨‍💻 開発フェーズ"
        DEV[開発者]
        FEATURE[feature/* branch]
        PR[Pull Request]
    end

    subgraph "🧪 テストフェーズ - GitHub Actions"
        LINT[✅ Lint<br/>コード品質チェック]
        TEST[🧪 Unit Test<br/>ユニットテスト]
        BUILD[🔨 Build<br/>コンテナビルド]
        SCAN[🔍 Security Scan<br/>Trivy/Snyk]
    end

    subgraph "📦 ビルドフェーズ"
        ECR_DEV[📦 ECR Dev<br/>開発環境]
    end

    subgraph "🌱 Dev環境"
        EKS_DEV[⎈ EKS Dev Cluster]
        TEST_AUTO[🤖 自動テスト]
    end

    subgraph "🎯 Stg環境"
        MERGE[main branch へマージ]
        TAG[🏷️ Version Tag<br/>v1.x.x]
        ECR_STG[📦 ECR Staging]
        TERRAFORM[🏗️ Terraform Apply<br/>インフラ更新]
        EKS_STG[⎈ EKS Staging Cluster]
        E2E[🧪 E2E Test<br/>統合テスト]
    end

    subgraph "🚀 Production環境"
        APPROVAL[👤 Manual Approval<br/>承認ゲート]
        ECR_PROD[📦 ECR Production]
        EKS_PROD[⎈ EKS Production Cluster]
        CANARY[🐤 Canary Deploy<br/>段階的デプロイ]
        ROLLBACK[↩️ Rollback<br/>ロールバック準備]
    end

    subgraph "📊 監視"
        MONITOR[📈 CloudWatch<br/>メトリクス監視]
        ALERT[🚨 Alert<br/>Slack/PagerDuty]
    end

    DEV -->|1. コミット| FEATURE
    FEATURE -->|2. PR作成| PR
    PR -->|3. トリガー| LINT

    LINT -->|Pass| TEST
    TEST -->|Pass| BUILD
    BUILD -->|Pass| SCAN
    SCAN -->|Pass| ECR_DEV

    ECR_DEV -->|4. デプロイ| EKS_DEV
    EKS_DEV -->|5. 実行| TEST_AUTO

    PR -->|6. マージ| MERGE
    MERGE -->|7. タグ付け| TAG
    TAG -->|8. ビルド| ECR_STG
    ECR_STG -->|9. インフラ更新| TERRAFORM
    TERRAFORM -->|10. デプロイ| EKS_STG
    EKS_STG -->|11. 実行| E2E

    E2E -->|Pass| APPROVAL
    APPROVAL -->|12. 承認| ECR_PROD
    ECR_PROD -->|13. デプロイ| EKS_PROD
    EKS_PROD -->|14. 段階的リリース| CANARY
    CANARY -.->|問題発生時| ROLLBACK

    EKS_PROD -->|15. メトリクス| MONITOR
    MONITOR -->|閾値超過| ALERT

    style DEV fill:#e1f5ff
    style LINT fill:#4CAF50,color:#fff
    style TEST fill:#4CAF50,color:#fff
    style SCAN fill:#FFC107
    style ECR_DEV fill:#ff9900,color:#fff
    style EKS_DEV fill:#326CE5,color:#fff
    style ECR_STG fill:#ff9900,color:#fff
    style EKS_STG fill:#326CE5,color:#fff
    style APPROVAL fill:#FF6B6B,color:#fff
    style ECR_PROD fill:#ff9900,color:#fff
    style EKS_PROD fill:#326CE5,color:#fff
    style CANARY fill:#4CAF50,color:#fff
    style ROLLBACK fill:#DC3545,color:#fff
    style MONITOR fill:#F46800,color:#fff
```

**デプロイ戦略**:

| 環境 | デプロイ方式 | 承認 | ロールバック |
|-----|------------|------|------------|
| Dev | 自動デプロイ | 不要 | 自動 |
| Staging | 自動デプロイ | 不要 | 自動 |
| Production | Canary Deploy | 必要 | 手動/自動 |

**Canary Deploy設定**:
1. 10% のトラフィックを新バージョンに
2. 10分間監視（エラー率、レイテンシ）
3. 問題なければ50% → 100%へ段階的に増加
4. エラー検知時は自動ロールバック

---

## 6. セキュリティアーキテクチャ

**概要**: 多層防御のセキュリティ構成

```mermaid
graph TB
    subgraph "🔐 Identity & Access"
        IAM[🔑 IAM Roles<br/>最小権限の原則]
        IRSA[🎫 IRSA<br/>Pod用IAMロール]
        MFA[🔒 MFA<br/>多要素認証]
    end

    subgraph "🌐 ネットワークセキュリティ"
        WAF[🛡️ AWS WAF<br/>Web攻撃防御]
        SHIELD[🛡️ AWS Shield<br/>DDoS防御]
        SG[🚧 Security Groups<br/>ファイアウォール]
        NACL[🚧 Network ACLs<br/>サブネット制御]
        NP[🔒 Network Policies<br/>Pod間通信制御]
    end

    subgraph "🔐 データ保護"
        TLS[🔐 TLS 1.3<br/>通信暗号化]
        KMS[🔑 AWS KMS<br/>暗号化キー管理]
        S3_ENC[📦 S3 Encryption<br/>保管時暗号化]
        RDS_ENC[🗄️ RDS Encryption<br/>DB暗号化]
        SECRET[🔐 Secrets Manager<br/>機密情報管理]
    end

    subgraph "🔍 監視・検知"
        TRAIL[📝 CloudTrail<br/>API操作ログ]
        GUARD[👁️ GuardDuty<br/>脅威検知]
        CONFIG[⚙️ AWS Config<br/>設定監査]
        FLOW[📊 VPC Flow Logs<br/>ネットワークログ]
    end

    subgraph "🐳 コンテナセキュリティ"
        SCAN_ECR[🔍 ECR Scanning<br/>イメージスキャン]
        TRIVY[🔍 Trivy<br/>脆弱性スキャン]
        PSP[🔒 Pod Security<br/>Pod制約]
        RBAC[🎫 K8s RBAC<br/>アクセス制御]
    end

    subgraph "⎈ アプリケーション"
        PODS[📦 Pods]
    end

    IAM -->|権限付与| IRSA
    IRSA -->|認証| PODS
    MFA -->|強制| IAM

    WAF -->|保護| SHIELD
    SHIELD -->|防御| SG
    SG -->|制御| NACL
    NACL -->|制御| NP
    NP -->|適用| PODS

    TLS -->|暗号化| PODS
    KMS -->|キー管理| S3_ENC
    KMS -->|キー管理| RDS_ENC
    SECRET -->|シークレット提供| PODS

    TRAIL -->|ログ記録| GUARD
    GUARD -->|検知| CONFIG
    CONFIG -->|監査| FLOW
    FLOW -->|ネットワーク監視| PODS

    SCAN_ECR -->|スキャン| TRIVY
    TRIVY -->|検証| PSP
    PSP -->|制約| RBAC
    RBAC -->|認可| PODS

    style IAM fill:#ff9900,color:#fff
    style IRSA fill:#ff9900,color:#fff
    style WAF fill:#FF6B6B,color:#fff
    style SHIELD fill:#FF6B6B,color:#fff
    style SG fill:#FF6B6B,color:#fff
    style TLS fill:#4CAF50,color:#fff
    style KMS fill:#ff9900,color:#fff
    style SECRET fill:#ff9900,color:#fff
    style TRAIL fill:#ff9900,color:#fff
    style GUARD fill:#ff9900,color:#fff
    style SCAN_ECR fill:#ff9900,color:#fff
    style TRIVY fill:#DC3545,color:#fff
    style RBAC fill:#326CE5,color:#fff
    style PODS fill:#326CE5,color:#fff
```

**セキュリティ対策一覧**:

| レイヤー | 対策 | 実装 |
|---------|------|------|
| エッジ | DDoS防御 | AWS Shield Standard/Advanced |
| ネットワーク | ファイアウォール | Security Groups, NACLs |
| アプリケーション | Web攻撃防御 | AWS WAF (OWASP Top 10) |
| データ | 暗号化 | TLS 1.3, KMS, S3/RDS暗号化 |
| アイデンティティ | 認証・認可 | IAM, IRSA, RBAC, MFA |
| コンテナ | 脆弱性管理 | ECR Scanning, Trivy, PSA |
| 監視 | 脅威検知 | GuardDuty, CloudTrail, Config |

---

## 📊 技術スタック一覧

### インフラストラクチャ
- **コンテナオーケストレーション**: Amazon EKS (Kubernetes)
- **コンピューティング**: EKS Managed Node Groups (t3.large, c5.xlarge)
- **ネットワーク**: VPC, ALB, NAT Gateway, VPC Endpoints
- **ストレージ**: S3, EBS, EFS

### データ基盤
- **RDBMS**: Amazon RDS/Aurora (PostgreSQL/MySQL)
- **NoSQL**: DynamoDB
- **Data Lake**: Amazon S3
- **Data Warehouse**: Redshift (オプション)
- **ストリーム処理**: Amazon Kinesis

### AI/ML
- **パイプライン**: Airflow on EKS / Kubeflow
- **モデル学習**: SageMaker / EKS GPU Nodes
- **推論**: EKS Inference Service
- **Feature Store**: DynamoDB / SageMaker Feature Store

### CI/CD
- **ソース管理**: GitHub
- **CI/CD**: GitHub Actions
- **コンテナレジストリ**: Amazon ECR
- **IaC**: Terraform

### 監視・ログ
- **メトリクス**: CloudWatch, Prometheus
- **可視化**: Grafana, CloudWatch Dashboards
- **ログ**: CloudWatch Logs, Fluent Bit
- **トレーシング**: AWS X-Ray

### セキュリティ
- **認証・認可**: IAM, IRSA, OIDC
- **シークレット管理**: AWS Secrets Manager
- **暗号化**: KMS, TLS 1.3
- **脅威検知**: GuardDuty, Security Hub
- **脆弱性管理**: ECR Scanning, Trivy

---

## 🎯 面接での説明ポイント

### 1. アーキテクチャ選定理由
**Q: なぜEKSを選択したのか?**
- ✅ コンテナ化による一貫した開発・本番環境
- ✅ マイクロサービスアーキテクチャに適している
- ✅ Auto Scalingによる柔軟なスケーリング
- ✅ AWS管理のコントロールプレーンで運用負荷削減

### 2. 高可用性の実現
**Q: システムの可用性をどう確保しているか?**
- ✅ マルチAZ構成（最低2つのAZ）
- ✅ ALBでのヘルスチェックと自動フェイルオーバー
- ✅ RDS Multi-AZ構成
- ✅ Podレプリカ数3以上で配置

### 3. セキュリティ対策
**Q: セキュリティはどう実装しているか?**
- ✅ 多層防御アーキテクチャ
- ✅ 最小権限の原則（IAM, IRSA, RBAC）
- ✅ データ暗号化（通信・保管時）
- ✅ 継続的な脆弱性管理

### 4. コスト最適化
**Q: コスト削減の工夫は?**
- ✅ Spot Instancesの活用（Dev/Staging環境）
- ✅ Auto Scalingで必要最小限のリソース
- ✅ S3ライフサイクルポリシーでストレージ最適化
- ✅ リザーブドインスタンスの活用（Production）

### 5. 運用・監視
**Q: 障害検知と対応は?**
- ✅ CloudWatch/Prometheusでメトリクス監視
- ✅ アラート設定とSlack/PagerDuty連携
- ✅ X-Rayで分散トレーシング
- ✅ Canary Deployで段階的リリース

---

## 📝 まとめ

このインフラ構成は以下の特徴を持ちます:

1. **スケーラビリティ**: EKSとAuto Scalingで需要に応じた自動スケール
2. **高可用性**: マルチAZ構成とロードバランシングで99.95%以上の可用性
3. **セキュリティ**: 多層防御と暗号化でデータ保護
4. **運用効率**: CI/CDとIaCで自動化とコード管理
5. **AI/ML統合**: データパイプラインと推論サービスのシームレスな統合

**最適な用途**: IoT、AI/MLアプリケーション、大規模データ処理
